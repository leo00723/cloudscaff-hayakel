<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="close()">
        <ion-icon
          slot="icon-only"
          name="arrow-back-outline"
          color="primary"
        ></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title
      >{{ !isEdit ? "Add Return" : "Edit Return" }}
      <ion-text *ngIf="loading">
        <i class="text-muted fs-6">(Saving...)</i>
      </ion-text>
    </ion-title>
  </ion-toolbar>
</ion-header>
<ion-content class="ion-padding">
  <form [formGroup]="form" *ngIf="form">
    <ion-row>
      <ion-col size="12">
        <ion-text color="medium">
          <h4>Return Information</h4>
        </ion-text>
      </ion-col>
      <ion-col size="12">
        <app-input-date
          [form]="form"
          controlName="returnDate"
          title="Return Date"
        ></app-input-date>
      </ion-col>
      <ion-col size="12">
        <app-input-reactive
          title="Notes"
          controlName="notes"
          [form]="form"
          [textarea]="true"
        >
        </app-input-reactive>
      </ion-col>
      <ion-col size="6">
        <ion-text color="medium">
          <h4>Inventory Information</h4>
        </ion-text>
      </ion-col>
      <ion-col
        size="6"
        class="text-end my-auto align-middle"
        *ngIf="!allowSend"
      >
        <ion-text color="medium"> <h6>Show all Items</h6> </ion-text>
        <ion-toggle
          [checked]="viewAll === true || searching === true ? true : false"
          (ionChange)="viewAll = !viewAll"
        ></ion-toggle>
      </ion-col>
      <ion-col size="12">
        <ion-searchbar
          debounce="250"
          mode="ios"
          placeholder="Search by code, category or name"
          (ionChange)="search($event)"
        >
        </ion-searchbar
      ></ion-col>
      <ion-col size="12">
        <table class="table table-sm table-bordered">
          <thead>
            <tr>
              <th scope="col">Code</th>
              <th scope="col">Category</th>
              <th scope="col">Name</th>
              <th scope="col" class="text-center">Available Qty</th>
              <th scope="col" class="text-center">Shipment Qty</th>
              <th scope="col" *ngIf="allowSend" class="text-center">
                Maintenance Qty
              </th>
              <th scope="col" *ngIf="allowSend" class="text-center">
                Damaged Qty
              </th>
              <th scope="col" *ngIf="allowSend" class="text-center">
                Lost Qty
              </th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let item of items; let i = index">
              <tr class="align-middle" *ngIf="viewAll; else viewShipment">
                <th scope="row">{{ item.code }}</th>
                <td>{{ item.category }}</td>
                <td>{{ item.name }}</td>
                <td class="text-center">
                  {{ item.availableQty }}
                </td>
                <td class="text-center">
                  <ion-input
                    #qty
                    debounce="200"
                    type="number"
                    [color]="
                      qty.value > item.availableQty || qty.value < 0
                        ? 'danger'
                        : 'success'
                    "
                    [clearOnEdit]="true"
                    [value]="item.shipmentQty"
                    (ionChange)="update($event, item, 'shipment')"
                    [readonly]="return.status !== 'pending' || allowSend"
                    (ionBlur)="autoSave()"
                  >
                  </ion-input>
                  <ion-label
                    color="danger"
                    *ngIf="qty.value > item.availableQty"
                  >
                    you cannot exceed the available qty
                  </ion-label>
                </td>
                <td class="text-center" *ngIf="allowSend">
                  <ion-input
                    #MaintenanceQty
                    debounce="200"
                    type="number"
                    [color]="item.error ? 'danger' : 'primary'"
                    [clearOnEdit]="true"
                    [value]="item.inMaintenanceQty"
                    (ionChange)="update($event, item, 'maintenance')"
                    [readonly]="return.status !== 'pending' && !allowSend"
                  >
                  </ion-input>
                  <ion-label color="danger" *ngIf="item.error">
                    you cannot exceed the shipment qty
                  </ion-label>
                </td>
                <td class="text-center" *ngIf="allowSend">
                  <ion-input
                    #DamagedQty
                    debounce="200"
                    type="number"
                    [color]="item.error ? 'danger' : 'warning'"
                    [clearOnEdit]="true"
                    [value]="item.damagedQty"
                    (ionChange)="update($event, item, 'damaged')"
                    [readonly]="return.status !== 'pending' && !allowSend"
                  >
                  </ion-input>
                  <ion-label color="danger" *ngIf="item.error">
                    you cannot exceed the shipment qty
                  </ion-label>
                </td>
                <td class="text-center" *ngIf="allowSend">
                  <ion-input
                    #LostQty
                    debounce="200"
                    type="number"
                    [color]="item.error ? 'danger' : 'danger'"
                    [clearOnEdit]="true"
                    [value]="item.lostQty"
                    (ionChange)="update($event, item, 'lost')"
                    [readonly]="return.status !== 'pending' && !allowSend"
                  >
                  </ion-input>
                  <ion-label color="danger" *ngIf="item.error">
                    you cannot exceed the shipment qty
                  </ion-label>
                </td>
              </tr>
              <ng-template #viewShipment>
                <tr
                  class="align-middle"
                  *ngIf="item.shipmentQty !== null && item.shipmentQty >= 0"
                >
                  <th scope="row">{{ item.code }}</th>
                  <td>{{ item.category }}</td>
                  <td>{{ item.name }}</td>
                  <td class="text-center">{{ item.availableQty }}</td>
                  <td class="text-center">
                    <ion-input
                      #qty
                      debounce="200"
                      type="number"
                      [color]="
                        qty.value > item.availableQty || qty.value < 0
                          ? 'danger'
                          : 'success'
                      "
                      [clearOnEdit]="true"
                      [value]="item.shipmentQty"
                      (ionChange)="update($event, item, 'shipment')"
                      (ionBlur)="autoSave()"
                    >
                    </ion-input>
                  </td></tr
              ></ng-template>
            </ng-container>
          </tbody>
        </table>
      </ion-col>
      <ion-col
        size="12"
        class="text-end"
        *ngIf="return.status !== 'void' && return.status !== 'sent'"
      >
        <ion-progress-bar
          type="indeterminate"
          *ngIf="loading"
        ></ion-progress-bar>
        <ion-button
          shape="round"
          [disabled]="form.invalid"
          *ngIf="!isEdit && !loading"
          (click)="createReturn()"
          >Create Return</ion-button
        >
        <ion-button
          shape="round"
          *ngIf="isEdit && !loading"
          color="danger"
          [disabled]="form.invalid"
          (click)="updateReturn('void')"
          >Void Return</ion-button
        >
        <ion-button
          shape="round"
          *ngIf="
            isEdit && return.status === 'submitted' && !loading && allowSend
          "
          color="success"
          [disabled]="form.invalid || error"
          (click)="updateReturn('sent')"
          >Accept Return</ion-button
        >
        <ion-button
          shape="round"
          color="tertiary"
          *ngIf="!loading && return.status === 'pending' && !allowSend"
          [disabled]="form.invalid"
          (click)="returnAll()"
          >Return all items</ion-button
        >
        <ion-button
          shape="round"
          *ngIf="
            isEdit && !loading && return.status === 'pending' && !allowSend
          "
          [disabled]="form.invalid"
          (click)="updateReturn('pending')"
          >Update Return</ion-button
        >
        <ion-button
          shape="round"
          color="success"
          *ngIf="
            isEdit && !loading && return.status === 'pending' && !allowSend
          "
          [disabled]="form.invalid"
          (click)="updateReturn('submitted')"
          >Submit Return</ion-button
        >
      </ion-col>
    </ion-row>
  </form>
</ion-content>
