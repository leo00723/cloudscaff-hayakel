<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="close()">
        <ion-icon
          slot="icon-only"
          name="arrow-back-outline"
          color="primary"
        ></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title
      >{{ !isEdit ? "Add Return" : "Edit Return" }}
      <ion-text *ngIf="loading">
        <i class="text-muted fs-6">(Saving...)</i>
      </ion-text>
    </ion-title>
    <ion-buttons slot="end">
      <ion-chip
        (click)="downloadPicklist()"
        mode="ios"
        shape="round"
        size="small"
        color="primary"
      >
        Picklist
      </ion-chip>
      <ion-chip
        *ngIf="
          isEdit && return.status !== 'pending' && return.status !== 'void'
        "
        (click)="downloadPdf()"
        mode="ios"
        shape="round"
        size="small"
        color="tertiary"
      >
        Return Note
      </ion-chip>
    </ion-buttons>
  </ion-toolbar>
</ion-header>
<ion-content class="ion-padding">
  <form [formGroup]="form" *ngIf="form">
    <ion-row>
      <ion-col size="12">
        <ion-text color="medium">
          <h4>Return Information</h4>
        </ion-text>
      </ion-col>
      <ion-col size="12">
        <app-input-reactive
          title="Returned By"
          controlName="createdByName"
          [form]="form"
          [readonly]="true"
        ></app-input-reactive>
      </ion-col>
      <ion-col size="12">
        <app-input-date
          [form]="form"
          controlName="returnDate"
          title="Return Date"
          [readonly]="return.status !== 'pending'"
        ></app-input-date>
      </ion-col>
      <ion-col size="12">
        <app-input-reactive
          title="Notes"
          controlName="notes"
          [form]="form"
          [textarea]="true"
          [readonly]="return.status !== 'pending'"
        >
        </app-input-reactive>
      </ion-col>
      <ng-container *ngIf="allowSend || return.status === 'on-route'">
        <ion-col size="12">
          <ion-text color="medium">
            <h4>Driver Information</h4>
          </ion-text>
        </ion-col>
        <ion-col size="12" sizeMd="4">
          <app-input-reactive
            title="Driver Name"
            controlName="driverName"
            [form]="form"
            [readonly]="return.status !== 'submitted'"
          >
          </app-input-reactive>
        </ion-col>
        <ion-col size="12" sizeMd="4">
          <app-input-reactive
            title="Driver Phone No"
            controlName="driverNo"
            [form]="form"
            [readonly]="return.status !== 'submitted'"
          >
          </app-input-reactive>
        </ion-col>
        <ion-col size="12" sizeMd="4">
          <app-input-reactive
            title="Vehicle Registration"
            controlName="vehicleReg"
            [form]="form"
            [readonly]="return.status !== 'submitted'"
          >
          </app-input-reactive>
        </ion-col>
      </ng-container>
      <ion-col size="6">
        <ion-text color="medium">
          <h4>Inventory Information</h4>
        </ion-text>
      </ion-col>
      <ion-col
        size="6"
        class="text-end my-auto align-middle"
        *ngIf="!allowSend"
      >
        <ion-text color="medium"> <h6>Show all Items</h6> </ion-text>
        <ion-toggle
          [checked]="viewAll === true || searching === true ? true : false"
          (ionChange)="viewAll = !viewAll"
        ></ion-toggle>
      </ion-col>
      <ion-col size="12">
        <ion-searchbar
          debounce="250"
          mode="ios"
          placeholder="Search by code, category or name"
          (ionChange)="search($event)"
        >
        </ion-searchbar
      ></ion-col>
      <ion-col size="12">
        <div class="table-responsive">
          <table class="table table-sm table-bordered table-fixed">
            <thead>
              <tr>
                <th scope="col">Code</th>
                <!-- <th scope="col">Category</th> -->
                <th scope="col">Name</th>
                <th scope="col" class="text-center">Location</th>
                <th scope="col" class="text-center">Site Qty</th>
                <th scope="col" class="text-center">Return Qty</th>
                <!-- <th scope="col" class="text-center">
                  Weight ({{ company.mass.symbol }})
                </th> -->
                <ng-container
                  *ngIf="
                    return.status !== 'void' &&
                    ((allowSend && return.status === 'collected') ||
                      (allowSend &&
                        user.permissionsList.includes('Inventory Admin')) ||
                      return.status === 'received')
                  "
                >
                  <th scope="col" class="text-center">Maintenance Qty</th>
                  <th scope="col" class="text-center">Damaged Qty</th>
                  <th scope="col" class="text-center">Lost Qty</th>
                </ng-container>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let item of items; let i = index">
                <tr class="align-middle" *ngIf="viewAll; else viewShipment">
                  <th scope="row">{{ item.code }}</th>
                  <!-- <td>{{ item.category }}</td> -->
                  <td>{{ item.name }}</td>
                  <td class="text-center">{{ item?.location }}</td>
                  <td class="text-center">
                    {{ item.availableQty }}
                  </td>
                  <td class="text-center">
                    <ion-input
                      #qty
                      debounce="500"
                      type="number"
                      [color]="
                        +qty.value > item.availableQty || +qty.value < 0
                          ? 'danger'
                          : 'success'
                      "
                      [clearOnEdit]="true"
                      [value]="item.shipmentQty"
                      (ionChange)="update($event, item, 'shipment')"
                      [readonly]="return.status !== 'pending' || allowSend"
                      (ionBlur)="autoSave()"
                    >
                    </ion-input>
                    <ion-label
                      color="danger"
                      *ngIf="+qty.value > item.availableQty"
                    >
                      you cannot exceed the available qty
                    </ion-label>
                  </td>
                  <!-- <td class="text-end">
                    {{ item.shipmentQty * item.weight | number }}
                  </td> -->
                  <ng-container
                    *ngIf="
                      return.status !== 'void' &&
                      ((allowSend && return.status === 'collected') ||
                        (allowSend &&
                          user.permissionsList.includes('Inventory Admin')) ||
                        return.status === 'received')
                    "
                  >
                    <td class="text-center">
                      <ion-input
                        #MaintenanceQty
                        debounce="200"
                        type="number"
                        [color]="item.error ? 'danger' : 'primary'"
                        [clearOnEdit]="true"
                        [value]="item.inMaintenanceQty"
                        (ionChange)="update($event, item, 'maintenance')"
                        [readonly]="
                          (return.status !== 'collected' && !allowSend) ||
                          return.status === 'received'
                        "
                      >
                      </ion-input>
                      <ion-label color="danger" *ngIf="item.error">
                        you cannot exceed the shipment qty
                      </ion-label>
                    </td>
                    <td class="text-center">
                      <ion-input
                        #DamagedQty
                        debounce="200"
                        type="number"
                        [color]="item.error ? 'danger' : 'warning'"
                        [clearOnEdit]="true"
                        [value]="item.damagedQty"
                        (ionChange)="update($event, item, 'damaged')"
                        [readonly]="
                          (return.status !== 'collected' && !allowSend) ||
                          return.status === 'received'
                        "
                      >
                      </ion-input>
                      <ion-label color="danger" *ngIf="item.error">
                        you cannot exceed the shipment qty
                      </ion-label>
                    </td>
                    <td class="text-center">
                      <ion-input
                        #LostQty
                        debounce="200"
                        type="number"
                        [color]="item.error ? 'danger' : 'danger'"
                        [clearOnEdit]="true"
                        [value]="item.lostQty"
                        (ionChange)="update($event, item, 'lost')"
                        [readonly]="
                          (return.status !== 'collected' && !allowSend) ||
                          return.status === 'received'
                        "
                      >
                      </ion-input>
                      <ion-label color="danger" *ngIf="item.error">
                        you cannot exceed the shipment qty
                      </ion-label>
                    </td>
                  </ng-container>
                </tr>
                <ng-template #viewShipment>
                  <tr
                    class="align-middle"
                    *ngIf="item.shipmentQty !== null && item.shipmentQty >= 0"
                  >
                    <th scope="row">{{ item.code }}</th>
                    <!-- <td>{{ item.category }}</td> -->
                    <td>{{ item.name }}</td>
                    <td class="text-center">{{ item?.location }}</td>
                    <td class="text-center">{{ item.availableQty }}</td>
                    <td class="text-center">
                      <ion-input
                        #qty
                        debounce="200"
                        type="number"
                        [color]="
                          +qty.value > item.availableQty || +qty.value < 0
                            ? 'danger'
                            : 'success'
                        "
                        [clearOnEdit]="true"
                        [value]="item.shipmentQty"
                        (ionChange)="update($event, item, 'shipment')"
                        (ionBlur)="autoSave()"
                        [readonly]="return.status !== 'pending' || allowSend"
                      >
                      </ion-input>
                    </td>
                    <!-- <td class="text-end">
                      {{ item.shipmentQty * item.weight | number }}
                    </td> -->
                  </tr>
                </ng-template>
              </ng-container>
            </tbody>
          </table>
        </div>

        <ion-item>
          <ion-label>Total weight</ion-label>
          <ion-label slot="end">
            {{ return.items ? (return.items | weight : true) : [] }}
          </ion-label>
        </ion-item>
      </ion-col>
      <ion-col
        size="12"
        *ngIf="
          return.status !== 'sent' &&
          return.status !== 'void' &&
          return.status !== 'received'
        "
      >
        <app-multiuploader></app-multiuploader>
      </ion-col>
      <ion-col size="12" *ngIf="return?.uploads?.length > 0">
        <app-title-block> Uploaded Files </app-title-block>
        <ion-row>
          <ion-col
            sizeXl="2"
            sizeLg="3"
            sizeMd="4"
            size="6"
            *ngFor="let file of return.uploads; let i = index"
          >
            <app-file-item [file]="file" [allowDelete]="false"></app-file-item>
          </ion-col>
        </ion-row>
      </ion-col>
      <ion-col
        class="mt-3"
        size="12"
        *ngIf="
          (return?.signedBy || return?.signedBy2) &&
          (return.status === 'collected' || return.status === 'received')
        "
      >
        <app-title-block> Signatures </app-title-block>

        <table class="table table-bordered mb-3">
          <tbody>
            <tr class="align-middle">
              <td>Signed By</td>
              <td class="text-center">
                <ion-text slot="end">{{ return?.signedBy }}</ion-text>
              </td>
            </tr>
            <tr class="align-middle">
              <td>Signature</td>
              <td class="text-center">
                <img [src]="return?.signature" />
              </td>
            </tr>
            <tr class="align-middle">
              <td>Signed By</td>
              <td class="text-center">
                <ion-text slot="end">{{ return?.signedBy2 }}</ion-text>
              </td>
            </tr>
            <tr class="align-middle">
              <td>Signature</td>
              <td class="text-center">
                <img [src]="return?.signature2" />
              </td>
            </tr>
          </tbody>
        </table>
      </ion-col>
      <ion-col
        size="12"
        *ngIf="
          return.status === 'on-route' ||
          (return.status === 'collected' && allowSend) ||
          (user.permissionsList.includes('Inventory Admin') &&
            allowSend &&
            return.status !== 'received' &&
            return.status !== 'void')
        "
      >
        <app-title-block> Signature </app-title-block>
        <app-signature-pad
          #signature
          [showSave]="blob ? false : true"
          (res)="sign($event)"
        ></app-signature-pad>
      </ion-col>
      <ion-col size="12" *ngIf="loading">
        <ion-progress-bar type="indeterminate"></ion-progress-bar>
      </ion-col>
    </ion-row>
    <ion-row
      *ngIf="
        return.status !== 'void' &&
        return.status !== 'sent' &&
        return.status !== 'received'
      "
    >
      <ion-col size="1">
        <ion-button
          shape="round"
          *ngIf="isEdit && !loading"
          color="danger"
          [disabled]="form.invalid"
          (click)="updateReturn('void')"
          >Void Return</ion-button
        >
      </ion-col>
      <ion-col size="11" class="text-end">
        <ion-button
          shape="round"
          [disabled]="form.invalid"
          *ngIf="!isEdit && !loading"
          (click)="createReturn()"
          >Create Return</ion-button
        >
        <ion-button
          shape="round"
          *ngIf="
            isEdit && return.status === 'submitted' && !loading && !allowSend
          "
          color="success"
          [disabled]="form.invalid"
          (click)="uploadFiles()"
          >Upload Files</ion-button
        >
        <ion-button
          shape="round"
          color="tertiary"
          *ngIf="!loading && return.status === 'pending' && !allowSend"
          [disabled]="form.invalid"
          (click)="returnAll()"
          >Return all items</ion-button
        >
        <ion-button
          shape="round"
          *ngIf="
            isEdit && !loading && return.status === 'pending' && !allowSend
          "
          [disabled]="form.invalid"
          (click)="updateReturn('pending')"
          >Update Return</ion-button
        >
        <ion-button
          shape="round"
          color="success"
          *ngIf="
            isEdit && !loading && return.status === 'pending' && !allowSend
          "
          [disabled]="form.invalid"
          (click)="updateReturn('submitted')"
          >Submit Return</ion-button
        >

        <ion-button
          shape="round"
          *ngIf="
            isEdit && return.status === 'submitted' && !loading && allowSend
          "
          color="success"
          [disabled]="form.invalid || error"
          (click)="updateReturn('on-route')"
          >Schedule Collection</ion-button
        >

        <ion-button
          shape="round"
          *ngIf="isEdit && !loading && return.status === 'on-route'"
          color="success"
          (click)="logCollection()"
          [disabled]="!blob || !return.signedBy"
          >Return Collected</ion-button
        >

        <ion-button
          shape="round"
          *ngIf="
            isEdit && !loading && return.status === 'collected' && allowSend
          "
          color="success"
          [disabled]="!blob || !return.signedBy2"
          (click)="approveReturn()"
          >Approve Return</ion-button
        >
        <ng-container *ngIf="user.permissionsList.includes('Inventory Admin')">
          <ion-button
            shape="round"
            fill="outline"
            *ngIf="isEdit && !loading && allowSend"
            color="tertiary"
            [disabled]="!blob || !return.signedBy2"
            (click)="approveReturn()"
            >Approve Immediately</ion-button
          >
        </ng-container>
      </ion-col>
    </ion-row>
  </form>
</ion-content>
