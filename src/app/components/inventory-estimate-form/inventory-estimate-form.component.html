<!-- SCAFFOLDS -->
<form [formGroup]="form" *ngIf="form">
  <ion-row>
    <ion-col size="6">
      <ion-text color="medium">
        <h4>Inventory Information</h4>
      </ion-text>
    </ion-col>
    <ion-col size="6" class="text-end my-auto align-middle">
      <ion-text color="medium"> <h6>Show all Items</h6> </ion-text>
      <ion-toggle
        [checked]="viewAll"
        (ionChange)="viewAll = !viewAll"
      ></ion-toggle>
    </ion-col>
    <ion-col size="6">
      <app-input-date
        [form]="form"
        controlName="startDate"
        title="Start Date"
        (fieldChange)="update('days')"
        (ionBlur)="update('date')"
      ></app-input-date>
    </ion-col>
    <ion-col size="6">
      <app-input-date
        [form]="form"
        controlName="endDate"
        [min]="field('startDate').value"
        title="End Date"
        (fieldChange)="update('date')"
      ></app-input-date>
    </ion-col>
    <ion-col size="6">
      <app-input-reactive
        title="Minimum days on hire"
        type="number"
        controlName="minHire"
        [form]="form"
        placeholder="Enter minimum hire"
        (fieldChange)="update('date')"
      >
      </app-input-reactive>
    </ion-col>
    <ion-col size="6">
      <app-input-reactive
        title="Days on hire"
        type="number"
        controlName="daysOnHire"
        [form]="form"
        (ionBlur)="update('days')"
      >
      </app-input-reactive>
    </ion-col>
    <ion-col size="12">
      <table class="table table-sm table-bordered">
        <thead>
          <tr>
            <th scope="col">Code</th>
            <th scope="col">Category</th>
            <th scope="col">Name</th>
            <th scope="col" class="text-center">Total Qty</th>
            <th scope="col" class="text-center">Available Qty</th>
            <th scope="col" class="text-center">Rate</th>
            <th scope="col" class="text-center">Days on Hire</th>
            <th scope="col" class="text-center">Shipment Qty</th>
            <th scope="col" class="text-end">
              Total ({{ company.currency.symbol }})
            </th>
          </tr>
        </thead>
        <tbody>
          <ng-container
            *ngFor="let item of items; let i = index; trackBy: trackItems"
          >
            <tr class="align-middle" *ngIf="viewAll; else viewShipment">
              <th scope="row">{{ item.code }}</th>
              <td>{{ item.category }}</td>
              <td>{{ item.name }}</td>
              <td class="text-center">
                {{ +item.yardQty + +item.crossHireQty }}
              </td>
              <td class="text-center">
                {{ item | calculate }}
              </td>
              <td class="text-center">
                <ion-input
                  #rate
                  debounce="200"
                  type="number"
                  [value]="item.hireCost"
                  (ionChange)="updateItems($event, item, 'rate')"
                  [readonly]="estimate.status !== 'pending'"
                >
                </ion-input>
              </td>
              <td class="text-center">
                {{ estimate.daysOnHire }}
              </td>
              <td class="text-center">
                <ion-input
                  #qty
                  debounce="200"
                  type="number"
                  [color]="item.error ? 'warning' : 'success'"
                  [clearOnEdit]="true"
                  [value]="item.shipmentQty"
                  (ionChange)="updateItems($event, item, 'qty')"
                  [readonly]="estimate.status !== 'pending'"
                >
                </ion-input>
                <ion-label color="warning" *ngIf="item.error">
                  you have exceeded the available qty
                </ion-label>
              </td>
              <td class="text-end">
                {{ company.currency.symbol
                }}{{ item.totalCost | number : "1.2-2" }}
              </td>
            </tr>
            <ng-template #viewShipment>
              <tr class="align-middle" *ngIf="item.shipmentQty > 0">
                <th scope="row">{{ item.code }}</th>
                <td>{{ item.category }}</td>
                <td>{{ item.name }}</td>
                <td class="text-center">
                  {{ +item.yardQty + +item.crossHireQty }}
                </td>
                <td class="text-center">
                  {{ item | calculate }}
                </td>
                <td class="text-center">
                  <ion-input
                    #rate
                    debounce="200"
                    type="number"
                    [value]="item.hireCost"
                    (ionChange)="updateItems($event, item, 'rate')"
                    [readonly]="estimate.status !== 'pending'"
                  >
                  </ion-input>
                </td>
                <td class="text-center">
                  {{ estimate.daysOnHire }}
                </td>
                <td class="text-center">
                  <ion-input
                    #qty
                    debounce="200"
                    type="number"
                    [color]="item.error ? 'warning' : 'success'"
                    [clearOnEdit]="true"
                    [value]="item.shipmentQty"
                    (ionChange)="updateItems($event, item, 'qty')"
                    [readonly]="estimate.status !== 'pending'"
                  >
                  </ion-input>
                  <ion-label color="warning" *ngIf="item.error">
                    you have exceeded the available qty
                  </ion-label>
                </td>
                <td class="text-end">
                  {{ company.currency.symbol
                  }}{{ item.totalCost | number : "1.2-2" }}
                </td>
              </tr>
            </ng-template>
          </ng-container>
        </tbody>
        <tfoot>
          <tr>
            <th class="text-end" colspan="7" scope="col">Subtotal</th>
            <th class="text-end" colspan="2" scope="col">
              {{ company.currency.symbol }}
              {{ estimate.itemHire | number : "0.2-2" }}
            </th>
          </tr>
        </tfoot>
      </table>
    </ion-col>
  </ion-row>
  <!-- LABOUR -->
  <app-title-block> Labor Information </app-title-block>
  <ion-row class="mt-3" class="card-outline mb-3">
    <ion-col>
      <app-input-select-reactive
        title="Labor Profile"
        placeholder="Select Labor Profile"
        controlName="broker"
        [form]="form"
        [selectedText]="field('broker').value.name"
        (fieldChange)="changeBroker()"
      >
        <ng-container *ngIf="brokers$ | async as brokers">
          <ion-select-option [value]="broker" *ngFor="let broker of brokers"
            >{{ broker.name }}
          </ion-select-option>
        </ng-container>
      </app-input-select-reactive>
    </ion-col>
  </ion-row>

  <ng-container *ngIf="field('broker').value">
    <ion-row
      formArrayName="labour"
      class="card-outline mb-3"
      *ngFor="let labour of labourForms.controls; let i = index"
    >
      <ion-col size="12">
        <ion-note> Item {{ i + 1 }} </ion-note>
        <ion-chip
          outline
          color="danger"
          class="ion-float-end"
          (click)="deleteLabour(i)"
        >
          <ion-label>Delete</ion-label>
        </ion-chip>
      </ion-col>
      <ion-col>
        <app-input-select-reactive
          title="Type"
          placeholder="Select Labour Type"
          controlName="type"
          [form]="labour"
          [selectedText]="arrField('labour', i, 'type').value.name"
          (fieldChange)="update('labour', i)"
        >
          <ng-container>
            <ion-select-option
              [value]="broker"
              *ngFor="let broker of field('broker').value.types"
            >
              {{ broker.name }}
            </ion-select-option>
          </ng-container>
        </app-input-select-reactive>
      </ion-col>
      <ng-container *ngIf="arrField('labour', i, 'type').value">
        <ion-col>
          <app-input-reactive
            title="Hours per day"
            type="number"
            controlName="hours"
            [form]="labour"
            placeholder="Enter hours"
            (fieldChange)="update('labour', i)"
          >
          </app-input-reactive>
        </ion-col>
        <ion-col>
          <app-input-reactive
            title="Days needed"
            type="number"
            controlName="days"
            [form]="labour"
            placeholder="Enter days"
            (fieldChange)="update('labour', i)"
          >
          </app-input-reactive>
        </ion-col>
        <ion-col>
          <app-input-reactive
            title="Qty"
            type="number"
            controlName="qty"
            [form]="labour"
            placeholder="Qty"
            (fieldChange)="update('labour', i)"
          >
          </app-input-reactive>
        </ion-col>
        <ion-col>
          <app-input-select-reactive
            title="Rate Profile"
            placeholder="Select Rate"
            controlName="rate"
            [form]="labour"
            (fieldChange)="update('labour', i)"
            [selectedText]="arrField('labour', i, 'rate').value.name"
          >
            <ng-container>
              <ion-select-option
                [value]="{
                  name: 'NT',
                  rate: arrField('labour', i, 'type').value.nt
                }"
              >
                Normal time
              </ion-select-option>
              <ion-select-option
                [value]="{
                  name: 'OT1',
                  rate: arrField('labour', i, 'type').value.ot1
                }"
              >
                Over time 1
              </ion-select-option>
              <ion-select-option
                [value]="{
                  name: 'OT2',
                  rate: arrField('labour', i, 'type').value.ot2
                }"
              >
                Over time 2
              </ion-select-option>
              <ion-select-option
                [value]="{
                  name: 'PH',
                  rate: arrField('labour', i, 'type').value.ph
                }"
              >
                Public holiday
              </ion-select-option>
            </ng-container>
          </app-input-select-reactive>
        </ion-col>
        <ion-col *ngIf="arrField('labour', i, 'rate').value">
          <app-input-text
            title="Rate override ({{
              arrField('labour', i, 'rate').value.name.startsWith('%')
                ? '%'
                : company.currency.symbol
            }})"
            type="number"
            [value]="arrField('labour', i, 'rate').value.rate"
            placeholder="Enter rate"
            (fieldChange)="updateRate('labour', $event, i)"
          >
          </app-input-text>
        </ion-col>
        <ion-col>
          <app-input-reactive
            title="Total ({{ company.currency.symbol }})"
            type="number"
            controlName="total"
            [form]="labour"
            placeholder="Total"
            [readonly]="true"
          >
          </app-input-reactive>
        </ion-col>
      </ng-container>
    </ion-row>

    <ion-row>
      <ion-col>
        <ion-fab-button
          size="small"
          class="m-auto"
          color="success"
          (click)="addLabour()"
        >
          <ion-icon name="add"></ion-icon>
        </ion-fab-button>
      </ion-col>
    </ion-row>
  </ng-container>

  <!-- TRANSPORT -->
  <app-title-block> Transport Information </app-title-block>
  <ion-row class="mt-3" class="card-outline mb-3">
    <ion-col>
      <app-input-select-reactive
        title="Transport Profile"
        placeholder="Select Transport Profile"
        controlName="transportProfile"
        [form]="form"
        [selectedText]="field('transportProfile').value.name"
        (fieldChange)="changeTransport()"
      >
        <ng-container *ngIf="transport$ | async as profiles">
          <ion-select-option [value]="profile" *ngFor="let profile of profiles"
            >{{ profile.name }}
          </ion-select-option>
        </ng-container>
      </app-input-select-reactive>
    </ion-col>
  </ion-row>
  <ng-container *ngIf="field('transportProfile').value">
    <ion-row
      formArrayName="transport"
      class="card-outline mb-3"
      *ngFor="let transport of transportForms.controls; let i = index"
    >
      <ion-col size="12">
        <ion-note> Item {{ i + 1 }} </ion-note>
        <ion-chip
          outline
          color="danger"
          class="ion-float-end"
          (click)="deleteTransport(i)"
        >
          <ion-label>Delete</ion-label>
        </ion-chip>
      </ion-col>
      <ion-col>
        <app-input-select-reactive
          title="Type"
          placeholder="Select Vehicle Type"
          controlName="type"
          [form]="transport"
          [selectedText]="arrField('transport', i, 'type').value.name"
          (fieldChange)="update('transport', i)"
        >
          <ng-container>
            <ion-select-option
              [value]="vehicle"
              *ngFor="let vehicle of field('transportProfile').value.types"
            >
              {{ vehicle.name }}
            </ion-select-option>
          </ng-container>
        </app-input-select-reactive>
      </ion-col>
      <ng-container *ngIf="arrField('transport', i, 'type').value">
        <ion-col>
          <app-input-text
            title="Max Load ({{ company.mass.symbol }})"
            type="number"
            [value]="arrField('transport', i, 'type').value.maxLoad"
            [readonly]="true"
          >
          </app-input-text>
        </ion-col>
        <ion-col>
          <app-input-reactive
            title="Hours per day"
            type="number"
            controlName="hours"
            [form]="transport"
            placeholder="Enter hours"
            (fieldChange)="update('transport', i)"
          >
          </app-input-reactive>
        </ion-col>
        <ion-col>
          <app-input-reactive
            title="Days needed"
            type="number"
            controlName="days"
            [form]="transport"
            placeholder="Enter days"
            (fieldChange)="update('transport', i)"
          >
          </app-input-reactive>
        </ion-col>
        <ion-col>
          <app-input-reactive
            title="Qty"
            type="number"
            controlName="qty"
            [form]="transport"
            placeholder="Qty"
            (fieldChange)="update('transport', i)"
          >
          </app-input-reactive>
        </ion-col>
        <ion-col>
          <app-input-text
            title="Rate override ({{ company.currency.symbol }})"
            type="number"
            [value]="arrField('transport', i, 'type').value.rate"
            placeholder="Enter rate"
            (fieldChange)="updateRate('transport', $event, i)"
          >
          </app-input-text>
        </ion-col>
        <ion-col>
          <app-input-reactive
            title="Extra Hire %"
            type="number"
            controlName="extraHirePercentage"
            placeholder="%"
            [form]="transport"
            (fieldChange)="updateRate('transport', null, i)"
          >
          </app-input-reactive>
        </ion-col>
        <ion-col>
          <app-input-reactive
            title="Extra Hire ({{ company.currency.symbol }})"
            type="number"
            controlName="extraHire"
            placeholder="Total Extra Hire"
            [form]="transport"
            [readonly]="true"
          >
          </app-input-reactive>
        </ion-col>
        <ion-col>
          <app-input-reactive
            title="Total ({{ company.currency.symbol }})"
            type="number"
            controlName="total"
            [form]="transport"
            placeholder="Total"
            [readonly]="true"
          >
          </app-input-reactive>
        </ion-col>
      </ng-container>
    </ion-row>

    <ion-row>
      <ion-col>
        <ion-fab-button
          size="small"
          class="m-auto"
          color="success"
          (click)="addTransport()"
        >
          <ion-icon name="add"></ion-icon>
        </ion-fab-button>
      </ion-col>
    </ion-row>
  </ng-container>

  <!-- ADDITIONALS -->
  <app-title-block> Additionals Information </app-title-block>
  <ion-row
    formArrayName="additionals"
    class="card-outline mb-3"
    *ngFor="let additional of additionalForms.controls; let i = index"
  >
    <ion-col size="12">
      <ion-note> Item {{ i + 1 }} </ion-note>
      <ion-chip
        outline
        color="danger"
        class="ion-float-end"
        (click)="deleteAdditional(i)"
      >
        <ion-label>Delete</ion-label>
      </ion-chip>
    </ion-col>
    <ion-col>
      <app-input-reactive
        title="Name"
        controlName="name"
        [form]="additional"
        placeholder="Item Name"
      >
      </app-input-reactive>
    </ion-col>
    <ion-col>
      <app-input-reactive
        title="Qty"
        type="number"
        controlName="qty"
        [form]="additional"
        placeholder="Qty"
        (fieldChange)="update('additionals', i)"
      >
      </app-input-reactive>
    </ion-col>
    <ion-col>
      <app-input-reactive
        title="Days on Hire"
        type="number"
        controlName="daysStanding"
        [form]="additional"
        placeholder="Days on hire"
        (fieldChange)="update('additionals', i)"
      >
      </app-input-reactive>
    </ion-col>
    <ion-col>
      <app-input-select-reactive
        title="Rate Profile"
        placeholder="Select Rate"
        controlName="rate"
        [form]="additional"
        (fieldChange)="update('additionals', i)"
        [selectedText]="arrField('additionals', i, 'rate').value.name"
      >
        <ng-container *ngIf="rates$ | async as rates">
          <ion-select-option
            [value]="rate"
            *ngFor="let rate of rates.additionalRates"
            >{{ rate.name }}
          </ion-select-option>
        </ng-container>
      </app-input-select-reactive>
    </ion-col>
    <ion-col *ngIf="arrField('additionals', i, 'rate').value">
      <app-input-text
        title="Rate override ({{
          arrField('additionals', i, 'rate').value.name.startsWith('%')
            ? '%'
            : company.currency.symbol
        }})"
        type="number"
        [value]="arrField('additionals', i, 'rate').value.rate"
        placeholder="Enter rate"
        (fieldChange)="updateRate('additionals', $event, i)"
      >
      </app-input-text>
    </ion-col>
    <ion-col>
      <app-input-reactive
        title="Extra Hire %"
        type="number"
        controlName="extraHirePercentage"
        placeholder="%"
        [form]="additional"
        (fieldChange)="updateRate('additionals', null, i)"
      >
      </app-input-reactive>
    </ion-col>
    <ion-col>
      <app-input-reactive
        title="Extra Hire ({{ company.currency.symbol }})"
        type="number"
        controlName="extraHire"
        placeholder="Total Extra Hire"
        [form]="additional"
        [readonly]="true"
      >
      </app-input-reactive>
    </ion-col>
    <ion-col>
      <app-input-reactive
        title="Total ({{ company.currency.symbol }})"
        type="number"
        controlName="total"
        [form]="additional"
        placeholder="Total"
        [readonly]="true"
      >
      </app-input-reactive>
    </ion-col>
  </ion-row>
  <ion-row>
    <ion-col>
      <ion-fab-button
        size="small"
        class="m-auto"
        color="success"
        (click)="addAdditional()"
      >
        <ion-icon name="add"></ion-icon>
      </ion-fab-button>
    </ion-col>
  </ion-row>

  <!-- BUDGET -->

  <app-budget-breakdown
    [estimate]="estimate"
    *ngIf="!updating"
  ></app-budget-breakdown>
</form>
