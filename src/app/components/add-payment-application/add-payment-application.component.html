<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="close()">
        <ion-icon
          slot="icon-only"
          name="arrow-back-outline"
          color="primary"
        ></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title
      >{{ !isEdit ? "Add Payment Application" : "Edit Shipment" }}
    </ion-title>
  </ion-toolbar>
</ion-header>
<ion-content class="ion-padding">
  <ng-container *ngIf="site$ | async as site">
    <ion-row class="py-2">
      <ion-col size="12">
        <ion-text>
          <h4>Payment Application</h4>
        </ion-text>
      </ion-col>

      <ion-col size="6">
        <ion-label>
          <h6>Code:</h6>
          <h6>Site name:</h6>
          <h6>Date Issued:</h6>
        </ion-label>
      </ion-col>
      <ion-col size="6">
        <ion-label>
          <h6>
            {{ site.code }}
          </h6>
          <h6>
            {{ site.name }}
          </h6>
          <h6>
            {{ date | date }}
          </h6>
        </ion-label>
      </ion-col>
    </ion-row>
    <ion-item-divider mode="md"></ion-item-divider>

    <app-company-info-detail
      [customer]="site.customer"
    ></app-company-info-detail>
  </ng-container>
  <ion-row>
    <ion-col size="12" *ngIf="estimates; else loading">
      <div class="table-responsive">
        <table class="table table-sm table-bordered">
          <thead>
            <tr class="align-middle">
              <th scope="col" class="text-center">Item No</th>
              <th scope="col">Description</th>
              <th scope="col" class="text-center">Value</th>
              <th scope="col" class="text-center">On Hire Date</th>
              <th scope="col" class="text-center">Handover No.</th>
              <th scope="col" class="text-center">Erect Value</th>
              <th scope="col" class="text-center">Erect % Applied For</th>
              <th scope="col" class="text-center">Erect Value Applied For</th>
              <th scope="col" class="text-center">Weeks Hire Inc</th>
              <th scope="col" class="text-center">Hire End</th>
              <th scope="col" class="text-center">Off Hire Date</th>
              <th scope="col" class="text-center">Dismantle Value</th>
              <th scope="col" class="text-center">Dismantle % Applied For</th>
              <th scope="col" class="text-center">
                Dismantle Value Applied For
              </th>
              <th scope="col" class="text-center">Hire %</th>
              <th scope="col" class="text-center">Extra Hire Rate PW</th>
              <th scope="col" class="text-center">Inspect/EH weeks</th>
              <th scope="col" class="text-center">Inspect/EH Charge</th>
              <th scope="col" class="text-end">
                Total ({{ company.currency.symbol }})
              </th>
            </tr>
          </thead>
          <tbody>
            <tr class="align-middle">
              <th scope="row" colspan="19">
                <ion-text color="success">Measured Work</ion-text>
              </th>
            </tr>
            <ng-container *ngFor="let estimate of estimates; let j = index">
              <tr class="align-middle bg-light">
                <th scope="row" colspan="19">{{ estimate.code }}</th>
              </tr>
              <tr class="align-middle">
                <th class="text-center" scope="row">1</th>
                <td>{{ estimate.scaffold.description }}</td>
                <td class="text-end">
                  {{ company.currency.symbol
                  }}{{
                    estimate.scaffold.total +
                      (estimate.scaffold.hireTotal
                        ? estimate.scaffold.hireTotal
                        : 0) | number: "0.2-2"
                  }}
                </td>
                <td class="text-center">
                  <ion-datetime-button
                    datetime="HD{{ j }}"
                  ></ion-datetime-button>
                  <ion-modal [keepContentsMounted]="true">
                    <ng-template>
                      <ion-datetime
                        id="HD{{ j }}"
                        presentation="date"
                        (ionChange)="change($event, estimate.scaffold, 'HD')"
                        [showDefaultButtons]="true"
                        [value]="estimate.scaffold.hireDate"
                      ></ion-datetime>
                    </ng-template>
                  </ion-modal>
                </td>
                <td class="text-center">
                  <ion-input
                    debounce="200"
                    type="text"
                    [clearOnEdit]="true"
                    [value]="estimate.scaffold.handover"
                  >
                  </ion-input>
                </td>
                <td class="text-center">
                  {{ company.currency.symbol
                  }}{{
                    (estimate.scaffold.total +
                      (estimate.scaffold.hireTotal
                        ? estimate.scaffold.hireTotal
                        : 0)) *
                      0.7 | number: "0.2-2"
                  }}
                </td>
                <td class="text-center">
                  <ion-input
                    debounce="200"
                    type="number"
                    [clearOnEdit]="true"
                    [value]="estimate.scaffold.appliedErectionPercentage"
                    (ionChange)="change($event, estimate.scaffold, 'EP')"
                  >
                  </ion-input>
                </td>
                <td class="text-center">
                  {{ company.currency.symbol
                  }}{{
                    estimate.scaffold.appliedErectionValue | number: "0.2-2"
                  }}
                </td>
                <td class="text-center">
                  {{
                    (estimate.scaffold.isWeeks
                      ? estimate.scaffold.daysStanding
                      : estimate.scaffold.daysStanding / 7
                    ) | number: "0.1-1"
                  }}
                </td>
                <td class="text-center">
                  {{
                    estimate.scaffold.hireEndDate
                      ? (estimate.scaffold.hireEndDate | date)
                      : ""
                  }}
                </td>
                <td class="text-center">
                  <ion-datetime-button
                    datetime="DD{{ j }}"
                  ></ion-datetime-button>
                  <ion-modal [keepContentsMounted]="true">
                    <ng-template>
                      <ion-datetime
                        id="DD{{ j }}"
                        presentation="date"
                        (ionChange)="change($event, estimate.scaffold, 'DD')"
                        [showDefaultButtons]="true"
                        [value]="estimate.scaffold.dismantleDate"
                      ></ion-datetime>
                    </ng-template>
                  </ion-modal>
                </td>
                <td class="text-center">
                  {{ company.currency.symbol
                  }}{{
                    (estimate.scaffold.total +
                      (estimate.scaffold.hireTotal
                        ? estimate.scaffold.hireTotal
                        : 0)) *
                      0.3 | number: "0.2-2"
                  }}
                </td>
                <td class="text-center">
                  <ion-input
                    debounce="200"
                    type="number"
                    [clearOnEdit]="true"
                    [value]="estimate.scaffold.appliedDismantlePercentage"
                    (ionChange)="change($event, estimate.scaffold, 'DP')"
                  >
                  </ion-input>
                </td>
                <td class="text-center">
                  {{ company.currency.symbol
                  }}{{
                    estimate.scaffold.appliedDismantleValue | number: "0.2-2"
                  }}
                </td>
                <td class="text-center">
                  {{ estimate.scaffold.extraHirePercentage }}
                </td>
                <td class="text-center">
                  {{ company.currency.symbol
                  }}{{ estimate.scaffold.extraHire | number: "0.2-2" }}
                </td>
                <td class="text-center">
                  <ion-input
                    debounce="200"
                    type="number"
                    [clearOnEdit]="true"
                    [value]="estimate.scaffold.extraHireWeeks"
                    (ionChange)="change($event, estimate.scaffold, 'EH')"
                  >
                  </ion-input>
                </td>
                <td class="text-center">
                  {{ company.currency.symbol
                  }}{{ estimate.scaffold.extraHireCharge | number: "0.2-2" }}
                </td>
                <td class="text-end">
                  {{ company.currency.symbol
                  }}{{ estimate.scaffold.grossTotal | number: "0.2-2" }}
                </td>
              </tr>
              <tr
                class="align-middle"
                *ngFor="let attachment of estimate.attachments; let i = index"
              >
                <th class="text-center" scope="row">{{ i + 2 }}</th>
                <td>{{ attachment.description }}</td>
                <td class="text-end">
                  {{ company.currency.symbol
                  }}{{
                    attachment.total +
                      (attachment.hireTotal ? attachment.hireTotal : 0)
                      | number: "0.2-2"
                  }}
                </td>
                <td class="text-center">
                  <ion-datetime-button
                    datetime="HDA{{ j }}{{ i }}"
                  ></ion-datetime-button>
                  <ion-modal [keepContentsMounted]="true">
                    <ng-template>
                      <ion-datetime
                        id="HDA{{ j }}{{ i }}"
                        presentation="date"
                        (ionChange)="change($event, attachment, 'HD')"
                        [showDefaultButtons]="true"
                        [value]="attachment.hireDate"
                      ></ion-datetime>
                    </ng-template>
                  </ion-modal>
                </td>
                <td class="text-center">
                  <ion-input
                    debounce="200"
                    type="text"
                    [clearOnEdit]="true"
                    [value]="attachment.handover"
                  >
                  </ion-input>
                </td>
                <td class="text-center">
                  {{ company.currency.symbol
                  }}{{
                    (attachment.total +
                      (attachment.hireTotal ? attachment.hireTotal : 0)) *
                      0.7 | number: "0.2-2"
                  }}
                </td>
                <td class="text-center">
                  <ion-input
                    debounce="200"
                    type="number"
                    [clearOnEdit]="true"
                    [value]="attachment.appliedErectionPercentage"
                    (ionChange)="change($event, attachment, 'EP')"
                  >
                  </ion-input>
                </td>
                <td class="text-center">
                  {{ company.currency.symbol
                  }}{{ attachment.appliedErectionValue | number: "0.2-2" }}
                </td>
                <td class="text-center">
                  {{
                    (attachment.isWeeks
                      ? attachment.daysStanding
                      : attachment.daysStanding / 7
                    ) | number: "0.1-1"
                  }}
                </td>
                <td class="text-center">
                  {{
                    attachment.hireEndDate
                      ? (attachment.hireEndDate | date)
                      : ""
                  }}
                </td>
                <td class="text-center">
                  <ion-datetime-button
                    datetime="DDA{{ j }}{{ i }}"
                  ></ion-datetime-button>
                  <ion-modal [keepContentsMounted]="true">
                    <ng-template>
                      <ion-datetime
                        id="DDA{{ j }}{{ i }}"
                        presentation="date"
                        (ionChange)="change($event, attachment, 'DD')"
                        [showDefaultButtons]="true"
                        [value]="attachment.dismantleDate"
                      ></ion-datetime>
                    </ng-template>
                  </ion-modal>
                </td>
                <td class="text-center">
                  {{ company.currency.symbol
                  }}{{
                    (attachment.total +
                      (attachment.hireTotal ? attachment.hireTotal : 0)) *
                      0.3 | number: "0.2-2"
                  }}
                </td>
                <td class="text-center">
                  <ion-input
                    debounce="200"
                    type="number"
                    [clearOnEdit]="true"
                    [value]="attachment.appliedDismantlePercentage"
                    (ionChange)="change($event, attachment, 'DP')"
                  >
                  </ion-input>
                </td>
                <td class="text-center">
                  {{ company.currency.symbol
                  }}{{ attachment.appliedDismantleValue | number: "0.2-2" }}
                </td>
                <td class="text-center">
                  {{ attachment.extraHirePercentage }}
                </td>
                <td class="text-center">
                  {{ company.currency.symbol
                  }}{{ attachment.extraHire | number: "0.2-2" }}
                </td>
                <td class="text-center">
                  <ion-input
                    debounce="200"
                    type="number"
                    [clearOnEdit]="true"
                    [value]="attachment.extraHireWeeks"
                    (ionChange)="change($event, attachment, 'EH')"
                  >
                  </ion-input>
                </td>
                <td class="text-center">
                  {{ company.currency.symbol
                  }}{{ attachment.extraHireCharge | number: "0.2-2" }}
                </td>
                <td class="text-end">
                  {{ company.currency.symbol
                  }}{{ attachment.grossTotal | number: "0.2-2" }}
                </td>
              </tr>
            </ng-container>
          </tbody>
          <tfoot>
            <tr>
              <th colspan="2" scope="col">Total Measured Work</th>
              <th class="text-end">
                {{ company.currency.symbol }}
                {{ V | number: "0.2-2" }}
              </th>
              <th colspan="2"></th>
              <th class="text-end">
                {{ company.currency.symbol }}
                {{ EV | number: "0.2-2" }}
              </th>
              <th></th>
              <th class="text-end">
                {{ company.currency.symbol }}
                {{ AEV | number: "0.2-2" }}
              </th>
              <th colspan="3"></th>
              <th class="text-end">
                {{ company.currency.symbol }}
                {{ DV | number: "0.2-2" }}
              </th>
              <th></th>
              <th class="text-end">
                {{ company.currency.symbol }}
                {{ ADV | number: "0.2-2" }}
              </th>
              <th colspan="3"></th>
              <th class="text-end">
                {{ company.currency.symbol }}
                {{ EHC | number: "0.2-2" }}
              </th>
              <th class="text-end">
                {{ company.currency.symbol }}
                {{ GT | number: "0.2-2" }}
              </th>
            </tr>
          </tfoot>
        </table>
      </div>
    </ion-col>
    <ng-template #loading>
      <ion-col size="12">
        <div class="ion-padding">
          <app-skeleton-text></app-skeleton-text>
          <app-skeleton-text></app-skeleton-text>
          <app-skeleton-text></app-skeleton-text>
          <app-skeleton-text></app-skeleton-text>
        </div>
      </ion-col>
    </ng-template>
  </ion-row>
</ion-content>
