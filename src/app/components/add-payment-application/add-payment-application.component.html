<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="close()">
        <ion-icon
          slot="icon-only"
          name="arrow-back-outline"
          color="primary"
        ></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title *ngIf="isPA; else OA"
      >{{ !isEdit ? "Add Payment Application" : "Edit Payment Application" }}
    </ion-title>
    <ng-template #OA>
      <ion-title
        >{{
          !isEdit ? "Add Operation Application" : "Edit Operation Application"
        }}
      </ion-title>
    </ng-template>
  </ion-toolbar>
</ion-header>
<ion-content class="ion-padding">
  <ng-container *ngIf="paymentApplication.site; else loadingData">
    <ion-row class="py-2">
      <ion-col size="12">
        <ion-text>
          <h4>{{ isPA ? "Payment Application" : "Operation Application" }}</h4>
        </ion-text>
      </ion-col>

      <ion-col size="6">
        <ion-label>
          <h6>Code:</h6>
          <h6>Site Code:</h6>
          <h6>Site name:</h6>
          <h6>Date Issued:</h6>
        </ion-label>
      </ion-col>
      <ion-col size="6">
        <ion-label>
          <h6>
            {{ paymentApplication.code }}
          </h6>
          <h6>
            {{ paymentApplication.site.code }}
          </h6>
          <h6>
            {{ paymentApplication.site.name }}
          </h6>
          <h6>
            {{ paymentApplication.date | date }}
          </h6>
        </ion-label>
      </ion-col>
    </ion-row>
    <ion-item-divider mode="md"></ion-item-divider>

    <app-company-info-detail
      [customer]="paymentApplication.site.customer"
    ></app-company-info-detail>

    <ion-item-divider mode="md"></ion-item-divider>

    <ion-row>
      <ion-col size="12" *ngIf="paymentApplication.estimates">
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead>
              <tr class="align-middle">
                <th scope="col" class="text-center">Item No</th>
                <th scope="col">Description</th>
                <th scope="col" class="text-center">Value</th>
                <th scope="col" class="text-center">On Hire Date</th>
                <th scope="col" class="text-center">Handover No.</th>
                <th scope="col" class="text-center">Erect Value</th>
                <th scope="col" class="text-center">Erect % Applied For</th>
                <th scope="col" class="text-center">Erect Value Applied For</th>
                <th scope="col" class="text-center">Weeks Hire Inc</th>
                <th scope="col" class="text-center">Hire End</th>
                <th scope="col" class="text-center">Off Hire Date</th>
                <th scope="col" class="text-center">Dismantle Value</th>
                <th scope="col" class="text-center">Dismantle % Applied For</th>
                <th scope="col" class="text-center">
                  Dismantle Value Applied For
                </th>
                <th scope="col" class="text-center">Hire %</th>
                <th scope="col" class="text-center">Extra Hire Rate PW</th>
                <th scope="col" class="text-center">Inspect/EH weeks</th>
                <th scope="col" class="text-center">Inspect/EH Charge</th>
                <th scope="col" class="text-end">
                  Previous Gross ({{
                    paymentApplication.company.currency.symbol
                  }})
                </th>
                <th scope="col" class="text-end">
                  Total Gross ({{ paymentApplication.company.currency.symbol }})
                </th>
                <th scope="col" class="text-end">
                  Current Total ({{
                    paymentApplication.company.currency.symbol
                  }})
                </th>
              </tr>
            </thead>
            <tbody>
              <tr class="align-middle">
                <th scope="row" colspan="21">
                  <ion-text color="success">Measured Work</ion-text>
                </th>
              </tr>
              <ng-container
                *ngFor="
                  let estimate of paymentApplication.estimates;
                  let j = index
                "
              >
                <tr class="align-middle bg-light">
                  <th scope="row" colspan="21">{{ estimate.code }}</th>
                </tr>
                <tr class="align-middle">
                  <th class="text-center" scope="row">1</th>
                  <td>{{ estimate.scaffold.description }}</td>
                  <td class="text-end">
                    {{ paymentApplication.company.currency.symbol
                    }}{{
                      estimate.scaffold.total +
                        (estimate.scaffold.hireTotal
                          ? estimate.scaffold.hireTotal
                          : 0) | number: "0.2-2"
                    }}
                  </td>
                  <td
                    class="text-center"
                    [ngClass]="estimate.scaffold.hireDate ? 'bg-success' : ''"
                  >
                    <ion-datetime-button
                      datetime="HD{{ j }}"
                    ></ion-datetime-button>
                    <ion-modal [keepContentsMounted]="true">
                      <ng-template>
                        <ion-datetime
                          id="HD{{ j }}"
                          presentation="date"
                          (ionChange)="change($event, estimate.scaffold, 'HD')"
                          [showDefaultButtons]="true"
                          [value]="estimate.scaffold.hireDate"
                        ></ion-datetime>
                      </ng-template>
                    </ion-modal>
                  </td>
                  <td class="text-center">
                    <ion-input
                      debounce="200"
                      type="text"
                      [clearOnEdit]="true"
                      [value]="estimate.scaffold.handover"
                    >
                    </ion-input>
                  </td>
                  <td class="text-center">
                    {{ paymentApplication.company.currency.symbol
                    }}{{
                      (estimate.scaffold.total +
                        (estimate.scaffold.hireTotal
                          ? estimate.scaffold.hireTotal
                          : 0)) *
                        0.7 | number: "0.2-2"
                    }}
                  </td>
                  <td class="text-center">
                    <ion-input
                      debounce="200"
                      type="number"
                      [clearOnEdit]="true"
                      [value]="estimate.scaffold.appliedErectionPercentage"
                      (ionChange)="change($event, estimate.scaffold, 'EP')"
                    >
                    </ion-input>
                  </td>
                  <td class="text-center">
                    {{ paymentApplication.company.currency.symbol
                    }}{{
                      estimate.scaffold.appliedErectionValue | number: "0.2-2"
                    }}
                  </td>
                  <td class="text-center">
                    {{
                      (estimate.scaffold.isWeeks
                        ? estimate.scaffold.daysStanding
                        : estimate.scaffold.daysStanding / 7
                      ) | number: "0.1-1"
                    }}
                  </td>
                  <td
                    class="text-center"
                    [ngClass]="
                      estimate.scaffold.hireEndDate ? 'bg-primary' : ''
                    "
                  >
                    {{
                      estimate.scaffold.hireEndDate
                        ? estimate.scaffold.hireEndDate
                        : ""
                    }}
                  </td>
                  <td
                    class="text-center"
                    [ngClass]="
                      estimate.scaffold.dismantleDate ? 'bg-danger' : ''
                    "
                  >
                    <ion-datetime-button
                      datetime="DD{{ j }}"
                    ></ion-datetime-button>
                    <ion-modal [keepContentsMounted]="true">
                      <ng-template>
                        <ion-datetime
                          id="DD{{ j }}"
                          presentation="date"
                          (ionChange)="change($event, estimate.scaffold, 'DD')"
                          [showDefaultButtons]="true"
                          [value]="estimate.scaffold.dismantleDate"
                        ></ion-datetime>
                      </ng-template>
                    </ion-modal>
                  </td>
                  <td class="text-center">
                    {{ paymentApplication.company.currency.symbol
                    }}{{
                      (estimate.scaffold.total +
                        (estimate.scaffold.hireTotal
                          ? estimate.scaffold.hireTotal
                          : 0)) *
                        0.3 | number: "0.2-2"
                    }}
                  </td>
                  <td class="text-center">
                    <ion-input
                      debounce="200"
                      type="number"
                      [clearOnEdit]="true"
                      [value]="estimate.scaffold.appliedDismantlePercentage"
                      (ionChange)="change($event, estimate.scaffold, 'DP')"
                    >
                    </ion-input>
                  </td>
                  <td class="text-center">
                    {{ paymentApplication.company.currency.symbol
                    }}{{
                      estimate.scaffold.appliedDismantleValue | number: "0.2-2"
                    }}
                  </td>
                  <td class="text-center">
                    {{ estimate.scaffold.extraHirePercentage }}
                  </td>
                  <td class="text-center">
                    {{ paymentApplication.company.currency.symbol
                    }}{{ estimate.scaffold.extraHire | number: "0.2-2" }}
                  </td>
                  <td class="text-center">
                    <ion-input
                      debounce="200"
                      type="number"
                      [clearOnEdit]="true"
                      [value]="estimate.scaffold.extraHireWeeks"
                      (ionChange)="change($event, estimate.scaffold, 'EH')"
                    >
                    </ion-input>
                  </td>
                  <td class="text-center">
                    {{ paymentApplication.company.currency.symbol
                    }}{{ estimate.scaffold.extraHireCharge | number: "0.2-2" }}
                  </td>
                  <td class="text-end">
                    {{ paymentApplication.company.currency.symbol
                    }}{{
                      (estimate.scaffold.previousGross
                        ? estimate.scaffold.previousGross
                        : 0
                      ) | number: "0.2-2"
                    }}
                  </td>
                  <td class="text-end">
                    {{ paymentApplication.company.currency.symbol
                    }}{{ estimate.scaffold.grossTotal | number: "0.2-2" }}
                  </td>
                  <td class="text-end">
                    {{ paymentApplication.company.currency.symbol
                    }}{{ estimate.scaffold.currentTotal | number: "0.2-2" }}
                  </td>
                </tr>
                <tr
                  class="align-middle"
                  *ngFor="let attachment of estimate.attachments; let i = index"
                >
                  <th class="text-center" scope="row">{{ i + 2 }}</th>
                  <td>{{ attachment.description }}</td>
                  <td class="text-end">
                    {{ paymentApplication.company.currency.symbol
                    }}{{
                      attachment.total +
                        (attachment.hireTotal ? attachment.hireTotal : 0)
                        | number: "0.2-2"
                    }}
                  </td>
                  <td
                    class="text-center"
                    [ngClass]="attachment.hireDate ? 'bg-success' : ''"
                  >
                    <ion-datetime-button
                      datetime="HDA{{ j }}{{ i }}"
                    ></ion-datetime-button>
                    <ion-modal [keepContentsMounted]="true">
                      <ng-template>
                        <ion-datetime
                          id="HDA{{ j }}{{ i }}"
                          presentation="date"
                          (ionChange)="change($event, attachment, 'HD')"
                          [showDefaultButtons]="true"
                          [value]="attachment.hireDate"
                        ></ion-datetime>
                      </ng-template>
                    </ion-modal>
                  </td>
                  <td class="text-center">
                    <ion-input
                      debounce="200"
                      type="text"
                      [clearOnEdit]="true"
                      [value]="attachment.handover"
                    >
                    </ion-input>
                  </td>
                  <td class="text-center">
                    {{ paymentApplication.company.currency.symbol
                    }}{{
                      (attachment.total +
                        (attachment.hireTotal ? attachment.hireTotal : 0)) *
                        0.7 | number: "0.2-2"
                    }}
                  </td>
                  <td class="text-center">
                    <ion-input
                      debounce="200"
                      type="number"
                      [clearOnEdit]="true"
                      [value]="attachment.appliedErectionPercentage"
                      (ionChange)="change($event, attachment, 'EP')"
                    >
                    </ion-input>
                  </td>
                  <td class="text-center">
                    {{ paymentApplication.company.currency.symbol
                    }}{{ attachment.appliedErectionValue | number: "0.2-2" }}
                  </td>
                  <td class="text-center">
                    {{
                      (attachment.isWeeks
                        ? attachment.daysStanding
                        : attachment.daysStanding / 7
                      ) | number: "0.1-1"
                    }}
                  </td>
                  <td
                    class="text-center"
                    [ngClass]="attachment.hireEndDate ? 'bg-warning' : ''"
                  >
                    {{
                      attachment.hireEndDate
                        ? (attachment.hireEndDate | date)
                        : ""
                    }}
                  </td>
                  <td class="text-center">
                    <ion-datetime-button
                      datetime="DDA{{ j }}{{ i }}"
                    ></ion-datetime-button>
                    <ion-modal [keepContentsMounted]="true">
                      <ng-template>
                        <ion-datetime
                          id="DDA{{ j }}{{ i }}"
                          presentation="date"
                          (ionChange)="change($event, attachment, 'DD')"
                          [showDefaultButtons]="true"
                          [value]="attachment.dismantleDate"
                        ></ion-datetime>
                      </ng-template>
                    </ion-modal>
                  </td>
                  <td class="text-center">
                    {{ paymentApplication.company.currency.symbol
                    }}{{
                      (attachment.total +
                        (attachment.hireTotal ? attachment.hireTotal : 0)) *
                        0.3 | number: "0.2-2"
                    }}
                  </td>
                  <td class="text-center">
                    <ion-input
                      debounce="200"
                      type="number"
                      [clearOnEdit]="true"
                      [value]="attachment.appliedDismantlePercentage"
                      (ionChange)="change($event, attachment, 'DP')"
                    >
                    </ion-input>
                  </td>
                  <td class="text-center">
                    {{ paymentApplication.company.currency.symbol
                    }}{{ attachment.appliedDismantleValue | number: "0.2-2" }}
                  </td>
                  <td class="text-center">
                    {{ attachment.extraHirePercentage }}
                  </td>
                  <td class="text-center">
                    {{ paymentApplication.company.currency.symbol
                    }}{{ attachment.extraHire | number: "0.2-2" }}
                  </td>
                  <td class="text-center">
                    <ion-input
                      debounce="200"
                      type="number"
                      [clearOnEdit]="true"
                      [value]="attachment.extraHireWeeks"
                      (ionChange)="change($event, attachment, 'EH')"
                    >
                    </ion-input>
                  </td>
                  <td class="text-center">
                    {{ paymentApplication.company.currency.symbol
                    }}{{ attachment.extraHireCharge | number: "0.2-2" }}
                  </td>
                  <td class="text-end">
                    {{ paymentApplication.company.currency.symbol
                    }}{{
                      (attachment.grossTotal ? attachment.grossTotal : 0)
                        | number: "0.2-2"
                    }}
                  </td>
                  <td class="text-end">
                    {{ paymentApplication.company.currency.symbol
                    }}{{ attachment.grossTotal | number: "0.2-2" }}
                  </td>
                  <td class="text-end">
                    {{ paymentApplication.company.currency.symbol
                    }}{{ attachment.currentTotal | number: "0.2-2" }}
                  </td>
                </tr>
              </ng-container>
            </tbody>
            <tfoot>
              <tr>
                <th colspan="2" scope="col">Total Measured Work</th>
                <th class="text-end">
                  {{ paymentApplication.company.currency.symbol }}
                  {{ paymentApplication.value | number: "0.2-2" }}
                </th>
                <th colspan="2"></th>
                <th class="text-end">
                  {{ paymentApplication.company.currency.symbol }}
                  {{ paymentApplication.erectionValue | number: "0.2-2" }}
                </th>
                <th></th>
                <th class="text-end">
                  {{ paymentApplication.company.currency.symbol }}
                  {{
                    paymentApplication.appliedErectionValue | number: "0.2-2"
                  }}
                </th>
                <th colspan="3"></th>
                <th class="text-end">
                  {{ paymentApplication.company.currency.symbol }}
                  {{ paymentApplication.dismantleValue | number: "0.2-2" }}
                </th>
                <th></th>
                <th class="text-end">
                  {{ paymentApplication.company.currency.symbol }}
                  {{
                    paymentApplication.appliedDismantleValue | number: "0.2-2"
                  }}
                </th>
                <th colspan="3"></th>
                <th class="text-end">
                  {{ paymentApplication.company.currency.symbol }}
                  {{ paymentApplication.extraHireCharge | number: "0.2-2" }}
                </th>
                <th class="text-end">
                  {{ paymentApplication.company.currency.symbol }}
                  {{ paymentApplication.previousGross | number: "0.2-2" }}
                </th>
                <th class="text-end">
                  {{ paymentApplication.company.currency.symbol }}
                  {{ paymentApplication.grossTotal | number: "0.2-2" }}
                </th>
                <th class="text-end">
                  {{ paymentApplication.company.currency.symbol }}
                  {{ paymentApplication.currentTotal | number: "0.2-2" }}
                </th>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="table-responsive mt-5">
          <table class="table table-sm table-bordered">
            <thead>
              <tr class="align-middle text-center">
                <th scope="col">Gross Total</th>
                <th scope="col">Previous Total</th>
                <th scope="col">Current Total</th>
                <!-- <th scope="col" class="text-center">Total Deductions</th>
                <th scope="col" class="text-center">Total Due</th> -->
              </tr>
            </thead>
            <tbody>
              <tr class="align-middle text-center">
                <th>
                  <ion-text
                    >{{ paymentApplication.company.currency.symbol
                    }}{{
                      paymentApplication.grossTotal | number: "0.2-2"
                    }}</ion-text
                  >
                </th>
                <th>
                  <ion-text
                    >{{ paymentApplication.company.currency.symbol
                    }}{{
                      (paymentApplication.site.previousGross
                        ? paymentApplication.site.previousGross
                        : 0
                      ) | number: "0.2-2"
                    }}</ion-text
                  >
                </th>
                <th>
                  <ion-text
                    >{{ paymentApplication.company.currency.symbol
                    }}{{
                      paymentApplication.grossTotal -
                        (paymentApplication.site.previousGross
                          ? paymentApplication.site.previousGross
                          : 0) | number: "0.2-2"
                    }}</ion-text
                  >
                </th>
              </tr>
            </tbody>
          </table>
        </div>
      </ion-col>
      <ion-col size="12">
        <ion-item fill="solid" lines="none" class="rounded-3 mb-3">
          <ion-label>Application Due Date</ion-label>
          <ion-datetime-button datetime="dueDate"></ion-datetime-button>
        </ion-item>
        <ion-modal [keepContentsMounted]="true">
          <ng-template>
            <ion-datetime
              id="dueDate"
              presentation="date"
              (ionChange)="setDate($event)"
              [showDefaultButtons]="true"
              [value]="paymentApplication.dueDate"
            ></ion-datetime>
          </ng-template>
        </ion-modal>
      </ion-col>
      <ion-col class="text-end">
        <ion-progress-bar
          type="indeterminate"
          *ngIf="loading"
        ></ion-progress-bar>
        <ion-button
          shape="round"
          *ngIf="isEdit && !loading"
          (click)="updatePA()"
          >{{
            isPA
              ? "Update Payment Application"
              : "Update Operation
          Application"
          }}</ion-button
        >
        <ion-button
          shape="round"
          *ngIf="!isEdit && !loading"
          (click)="createPA()"
          >{{
            isPA ? "Save Payment Application" : "Save Operation Application"
          }}
        </ion-button>
        <ion-button
          color="success"
          shape="round"
          *ngIf="isEdit && !loading && !isPA"
          (click)="createPA(true)"
          >Create Payment Application
        </ion-button>
      </ion-col>
    </ion-row>
  </ng-container>
  <ng-template #loadingData>
    <ion-col size="12">
      <div class="ion-padding">
        <app-skeleton-text></app-skeleton-text>
        <app-skeleton-text></app-skeleton-text>
        <app-skeleton-text></app-skeleton-text>
        <app-skeleton-text></app-skeleton-text>
      </div>
    </ion-col>
  </ng-template>
</ion-content>
