<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="close()" color="primary" mode="md">
        <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title
      >{{ isEdit ? "Update Credit Note" : "Create Credit Note" }}
    </ion-title>
    <ion-buttons slot="end">
      <ion-button
        slot="end"
        fill="solid"
        shape="round"
        class="text-capitalize"
        (click)="isEdit ? createCredit() : updateCredit('pending')"
        color="primary"
      >
        Save
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  <ion-toolbar>
    <ion-segment
      (ionChange)="segmentChanged($event)"
      selectOnFocus="true"
      [value]="active"
    >
      <ion-segment-button value="overview">
        <ion-label>Overview</ion-label>
      </ion-segment-button>
      <ion-segment-button value="additionals">
        <ion-label>Items</ion-label>
      </ion-segment-button>
      <ion-segment-button value="summary">
        <ion-label>Summary</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content fullscreen="true" class="ion-padding">
  <div class="container" *ngIf="company" [ngSwitch]="active">
    <form name="credit" [formGroup]="form" *ngIf="!isLoading">
      <!-- OVERVIEW TAB -->
      <ion-grid *ngSwitchDefault>
        <ion-row class="card-outline mb-3">
          <ion-col size="12">
            <ion-text color="medium">
              <h4>Project Information</h4>
            </ion-text>
          </ion-col>

          <ion-col size="12">
            <app-input-reactive
              title="Project Name"
              controlName="siteName"
              [form]="form"
              placeholder="Enter Project Name"
            >
            </app-input-reactive>
          </ion-col>
        </ion-row>
        <ion-row class="card-outline mb-3">
          <ion-col size="12">
            <app-input-select-reactive
              (fieldChange)="changeCustomer($event)"
              title="Customer"
              placeholder="Select Customer"
              controlName="customer"
              [form]="form"
              [selectedText]="field('customer').value.name"
            >
              <ng-container *ngIf="customers$ | async as customers">
                <ion-select-option class="fw-bold" value="add">
                  Create new Customer
                </ion-select-option>
                <ion-select-option
                  [value]="customer"
                  *ngFor="let customer of customers"
                  >{{ customer.name }}
                </ion-select-option>
              </ng-container>
            </app-input-select-reactive>
          </ion-col>
          <ion-col size="12" *ngIf="show === 'editCustomer'">
            <app-customer
              [customer]="field('customer').value"
              [isUpdate]="credit.status === 'pending'"
              [isCreate]="false"
              [companyId]="company.id"
            >
            </app-customer>
          </ion-col>
          <ion-col size="12" *ngIf="show === 'addCustomer'">
            <app-customer
              [companyId]="company.id"
              (newCustomer)="newCustomer($event)"
              [isCreate]="true"
            >
            </app-customer>
          </ion-col>
        </ion-row>
        <ion-row class="card-outline mb-3">
          <ion-col size="12">
            <app-input-reactive
              title="Message"
              controlName="message"
              [form]="form"
              placeholder="Enter a credit message"
              [textarea]="true"
            >
            </app-input-reactive>
          </ion-col>

          <ion-col sizeMd="4" size="12">
            <app-input-reactive
              title="Discount %"
              controlName="discountPercentage"
              [form]="form"
              placeholder="Enter a discount %"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col sizeMd="4" size="6">
            <app-input-date
              [form]="form"
              controlName="startDate"
              title="Start Date"
            ></app-input-date>
          </ion-col>
          <ion-col sizeMd="4" size="6" *ngIf="field('startDate').value">
            <app-input-date
              [form]="form"
              controlName="endDate"
              [min]="field('startDate').value"
              title="End Date"
            ></app-input-date>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col size="12" class="text-end">
            <ion-button shape="round" (click)="nextView('additionals')"
              >Next</ion-button
            >
          </ion-col>
        </ion-row>
      </ion-grid>

      <!-- ADDITIONALS TAB -->

      <ion-grid *ngSwitchCase="'additionals'">
        <ion-row class="mt-3">
          <ion-col size="12">
            <ion-text color="medium">
              <h4>Item Information</h4>
            </ion-text>
          </ion-col>
        </ion-row>

        <ion-row
          formArrayName="additionals"
          class="card-outline mb-3"
          *ngFor="let additional of additionalForms.controls; let i = index"
        >
          <ion-col size="12">
            <ion-note> Item {{ i + 1 }} </ion-note>
            <ion-chip
              outline
              color="danger"
              class="ion-float-end"
              (click)="deleteAdditional(i)"
            >
              <ion-label>Delete</ion-label>
            </ion-chip>
          </ion-col>
          <ion-col size="12">
            <app-input-reactive
              title="Description"
              [textarea]="true"
              controlName="name"
              [form]="additional"
              placeholder="Item Description"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Code"
              controlName="code"
              [form]="additional"
              placeholder="CD5466"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Qty"
              type="number"
              controlName="qty"
              [form]="additional"
              placeholder="Qty"
              (fieldChange)="update('additionals', i)"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Unit"
              controlName="unit"
              [form]="additional"
              placeholder="Unit of measure"
              (fieldChange)="update('additionals', i)"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Cost ({{ company.currency.symbol }})"
              type="number"
              controlName="rate"
              [form]="additional"
              placeholder="Cost per item"
              (fieldChange)="update('additionals', i)"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Discount %"
              type="number"
              controlName="discountPercentage"
              [form]="additional"
              placeholder="% of discount"
              (fieldChange)="update('additionals', i)"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Total ({{ company.currency.symbol }})"
              type="number"
              controlName="total"
              [form]="additional"
              placeholder="Total"
              [readonly]="true"
            >
            </app-input-reactive>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col>
            <ion-fab-button
              size="small"
              class="m-auto"
              color="success"
              (click)="addAdditional()"
            >
              <ion-icon name="add"></ion-icon>
            </ion-fab-button>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="12" class="text-end">
            <ion-button shape="round" (click)="nextView('summary')"
              >Next</ion-button
            >
          </ion-col>
        </ion-row>
      </ion-grid>

      <!-- SUMMARY TAB -->

      <ion-grid *ngSwitchCase="'summary'">
        <app-credit-summary
          [credit]="credit"
          [canDownload]="isEdit && form.valid"
        ></app-credit-summary>

        <ion-row>
          <ion-progress-bar
            type="indeterminate"
            *ngIf="loading"
          ></ion-progress-bar>
          <ion-col *ngIf="isEdit && credit.status === 'pending'">
            <ion-button
              size="block"
              shape="round"
              color="danger"
              [disabled]="form.invalid"
              (click)="updateCredit('rejected')"
              >Rejected</ion-button
            >
          </ion-col>
          <ion-col class="text-end">
            <ion-button
              size="block"
              shape="round"
              color="warning"
              *ngIf="isEdit && credit.status === 'pending'"
              (click)="updateCredit('pending')"
              >Update Credit Note</ion-button
            >
            <ion-button
              size="block"
              shape="round"
              *ngIf="!isEdit"
              (click)="createCredit()"
              >Create Credit Note</ion-button
            >
          </ion-col>
          <ion-col *ngIf="isEdit && credit.status === 'pending'">
            <ion-button
              size="block"
              shape="round"
              color="success"
              [disabled]="form.invalid"
              (click)="updateCredit('accepted')"
            >
              Accepted
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </form>
  </div>
</ion-content>
