<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="close()" color="primary" mode="md">
        <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ isEdit ? "Update Estimate" : "Create Estimate" }} </ion-title>
    <ion-buttons slot="end">
      <ion-button
        *ngIf="estimate.status === 'pending'"
        slot="end"
        fill="solid"
        shape="round"
        class="text-capitalize"
        (click)="isEdit ? updateEstimate('pending') : createEstimate()"
        color="primary"
      >
        Save
      </ion-button>
      <ion-button
        *ngIf="
          estimate.status === 'rejected' &&
          (user.role === 'Owner' || user.role === 'Super-Admin')
        "
        slot="end"
        fill="solid"
        shape="round"
        class="text-capitalize"
        (click)="isEdit ? updateEstimate('pending') : createEstimate()"
        color="success"
      >
        Activate Estimate
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  <ion-toolbar>
    <ion-segment
      scrollable
      (ionChange)="segmentChanged($event)"
      selectOnFocus="true"
      [value]="active"
      mode="md"
    >
      <ion-segment-button value="overview">
        <ion-label>Overview</ion-label>
      </ion-segment-button>
      <ion-segment-button value="scaffolds">
        <ion-label>Scaffold</ion-label>
      </ion-segment-button>
      <ion-segment-button value="labour">
        <ion-label>Labor</ion-label>
      </ion-segment-button>
      <ion-segment-button value="transport">
        <ion-label>Transport</ion-label>
      </ion-segment-button>
      <ion-segment-button value="additionals">
        <ion-label>Additionals</ion-label>
      </ion-segment-button>
      <ion-segment-button value="budget">
        <ion-label>Private Budget</ion-label>
      </ion-segment-button>
      <ion-segment-button value="summary">
        <ion-label>Summary</ion-label>
      </ion-segment-button>
      <ion-segment-button value="comments" *ngIf="isEdit">
        <ion-label>Comments</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content fullscreen="true" class="ion-padding">
  <div *ngIf="company" [ngSwitch]="active">
    <form name="estimate" [formGroup]="form" *ngIf="!isLoading && form">
      <!-- OVERVIEW TAB -->
      <ion-grid *ngSwitchDefault>
        <ion-row class="card-outline mb-3">
          <ion-col size="12">
            <ion-text color="medium">
              <h4>Customer Information</h4>
            </ion-text>
          </ion-col>

          <ion-col size="12">
            <app-input-reactive
              title="Site Name"
              controlName="siteName"
              [form]="form"
              placeholder="Enter Site Name"
            >
            </app-input-reactive>
          </ion-col>
        </ion-row>
        <ion-row class="card-outline mb-3">
          <ion-col size="12">
            <app-searchable-select
              (click)="select.open()"
              *ngIf="customers$ | async as customers"
              title="Select Customer"
              [data]="customers"
              itemTextField="name"
              [add]="true"
              (selectedChanged)="changeCustomer($event)"
              #select
            ></app-searchable-select>
          </ion-col>
          <ion-col size="12" *ngIf="show === 'editCustomer'">
            <app-customer
              [customer]="field('customer').value"
              [isUpdate]="
                estimate.status === 'pending' || estimate.status === 'revised'
              "
              [isCreate]="false"
              [companyId]="company.id"
            >
            </app-customer>
          </ion-col>
          <ion-col size="12" *ngIf="show === 'addCustomer'">
            <app-customer
              [companyId]="company.id"
              (newCustomer)="newCustomer($event)"
              [isCreate]="true"
            >
            </app-customer>
          </ion-col>
        </ion-row>
        <ion-row class="card-outline mb-3">
          <ion-col size="12">
            <ion-item
              fill="solid"
              lines="none"
              class="rounded-3 my-3"
              mode="md"
            >
              <ion-label position="stacked">Message</ion-label>
              <ion-textarea #message formControlName="message"></ion-textarea>
            </ion-item>
          </ion-col>

          <ion-col sizeMd="4" size="12">
            <app-input-reactive
              title="Discount %"
              controlName="discountPercentage"
              [form]="form"
              placeholder="Enter a discount %"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col sizeMd="4" size="6">
            <app-input-date
              [form]="form"
              controlName="startDate"
              title="Start Date"
            ></app-input-date>
          </ion-col>
          <ion-col sizeMd="4" size="6" *ngIf="field('startDate').value">
            <app-input-date
              [form]="form"
              controlName="endDate"
              [min]="field('startDate').value"
              title="End Date"
            ></app-input-date>
          </ion-col>
        </ion-row>
        <ion-row class="card-outline mb-3"> </ion-row>
        <ion-row>
          <ion-col size="12" class="text-end">
            <ion-button shape="round" (click)="nextView('scaffolds')"
              >Next</ion-button
            >
          </ion-col>
        </ion-row>
      </ion-grid>

      <!-- SCAFFOLDS TAB -->

      <ion-grid *ngSwitchCase="'scaffolds'">
        <!-- SCAFFOLDS -->
        <ion-row class="card-outline mb-3">
          <ion-col size="12">
            <ion-text color="medium">
              <h4>{{ company.terminology.scaffold }} Details</h4>
            </ion-text>
          </ion-col>

          <ion-col size="12">
            <ion-row formGroupName="scaffold">
              <ion-col size="12">
                <app-input-select-reactive
                  title="Scaffold Type"
                  placeholder="Select Type"
                  controlName="type"
                  [form]="field('scaffold')"
                  [selectedText]="field('scaffold.type').value"
                >
                  <ng-container *ngIf="types$ | async as types">
                    <ion-select-option
                      [value]="type"
                      *ngFor="let type of types.types"
                      >{{ type }}
                    </ion-select-option>
                  </ng-container>
                </app-input-select-reactive>
              </ion-col>
              <ion-col size="6">
                <app-input-reactive
                  title="Description"
                  controlName="description"
                  placeholder="Enter description"
                  [form]="field('scaffold')"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col size="3">
                <app-input-reactive
                  title="Extra Hire %"
                  type="number"
                  controlName="extraHirePercentage"
                  [form]="field('scaffold')"
                  placeholder="%"
                  (fieldChange)="update('scaffold')"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col size="3">
                <app-input-reactive
                  title="Extra Hire ({{ company.currency.symbol }})"
                  type="number"
                  controlName="extraHire"
                  [form]="field('scaffold')"
                  placeholder="Total Extra Hire"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Length ({{ company.measurement.symbol }})"
                  type="number"
                  controlName="length"
                  [form]="field('scaffold')"
                  placeholder="L"
                  (fieldChange)="update('scaffold')"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Width ({{ company.measurement.symbol }})"
                  type="number"
                  controlName="width"
                  [form]="field('scaffold')"
                  placeholder="W"
                  (fieldChange)="update('scaffold')"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Height ({{ company.measurement.symbol }})"
                  type="number"
                  controlName="height"
                  [form]="field('scaffold')"
                  placeholder="H"
                  (fieldChange)="update('scaffold')"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Lifts"
                  type="number"
                  controlName="lifts"
                  [form]="field('scaffold')"
                  placeholder="No. Lifts"
                  (fieldChange)="update('scaffold')"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Boarded Lifts"
                  type="number"
                  controlName="boardedLifts"
                  [form]="field('scaffold')"
                  placeholder="No. Boarded Lifts"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Level"
                  type="number"
                  [readonly]="true"
                  controlName="level"
                  [form]="field('scaffold')"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-select-reactive
                  title="Rate Profile"
                  placeholder="Select Rate"
                  controlName="rate"
                  [form]="field('scaffold')"
                  [selectedText]="field('scaffold.rate').value.name"
                  (fieldChange)="update('scaffold')"
                >
                  <ng-container *ngIf="rates$ | async as rates">
                    <ion-select-option
                      [value]="rate"
                      *ngFor="let rate of rates.scaffoldRates"
                      >{{ rate.name }}
                    </ion-select-option>
                  </ng-container>
                </app-input-select-reactive>
              </ion-col>
              <ion-col *ngIf="field('scaffold.rate').value">
                <app-input-text
                  title="Rate override ({{
                    field('scaffold.rate').value.name.startsWith('%')
                      ? '%'
                      : company.currency.symbol
                  }})"
                  type="number"
                  [value]="field('scaffold.rate').value.rate"
                  placeholder="Enter rate"
                  (fieldChange)="updateRate('scaffold', $event)"
                >
                </app-input-text>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Total ({{ company.currency.symbol }})"
                  type="number"
                  controlName="total"
                  [form]="field('scaffold')"
                  [readonly]="true"
                  placeholder="Total"
                >
                </app-input-reactive>
              </ion-col>
            </ion-row>
            <ion-row formGroupName="scaffold">
              <ion-col size="12">
                <ion-text class="small" color="medium"
                  >{{ company.terminology.hire }} Details</ion-text
                >
              </ion-col>
              <ion-col>
                <app-input-select-reactive
                  title="{{ company.terminology.hire }} Period"
                  placeholder="Select Hire Period"
                  controlName="isWeeks"
                  [form]="field('scaffold')"
                  [selectedText]="
                    field('scaffold.isWeeks').value ? 'Weeks' : 'Days'
                  "
                  (fieldChange)="update('scaffold')"
                >
                  <ng-container>
                    <ion-select-option [value]="true">Weeks </ion-select-option>
                    <ion-select-option [value]="false">Days </ion-select-option>
                  </ng-container>
                </app-input-select-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  [title]="
                    field('scaffold.isWeeks').value
                      ? 'Weeks Standing'
                      : 'Days Standing'
                  "
                  type="number"
                  controlName="daysStanding"
                  [form]="field('scaffold')"
                  [placeholder]="
                    field('scaffold.isWeeks').value
                      ? 'Enter Weeks'
                      : 'Enter Days'
                  "
                  (fieldChange)="update('scaffold')"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-select-reactive
                  title="Rate Profile"
                  placeholder="Select Rate"
                  controlName="hireRate"
                  [form]="field('scaffold')"
                  [selectedText]="field('scaffold.hireRate').value.name"
                  (fieldChange)="update('scaffold')"
                >
                  <ng-container *ngIf="rates$ | async as rates">
                    <ion-select-option
                      [value]="rate"
                      *ngFor="let rate of rates.hireRates"
                      >{{ rate.name }}
                    </ion-select-option>
                  </ng-container>
                </app-input-select-reactive>
              </ion-col>
              <ion-col *ngIf="field('scaffold.hireRate').value">
                <app-input-text
                  title="Rate override ({{
                    field('scaffold.hireRate').value.name.startsWith('%')
                      ? '%'
                      : company.currency.symbol
                  }})"
                  type="number"
                  [value]="field('scaffold.hireRate').value.rate"
                  placeholder="Enter rate"
                  (fieldChange)="updateRate('scaffoldHire', $event)"
                >
                </app-input-text>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Total ({{ company.currency.symbol }})"
                  type="number"
                  controlName="hireTotal"
                  [form]="field('scaffold')"
                  [readonly]="true"
                  placeholder="Hire Total"
                >
                </app-input-reactive>
              </ion-col>
            </ion-row>
            <ion-row
              formArrayName="attachments"
              class="mb-3"
              *ngFor="
                let attachment of attachmentsForms.controls;
                let i = index
              "
            >
              <ion-col size="12">
                <hr />
                <ion-note> Attachment {{ i + 1 }} </ion-note>
                <ion-chip
                  outline
                  color="danger"
                  class="ion-float-end"
                  (click)="deleteAttachment(i)"
                >
                  <ion-label>Delete</ion-label>
                </ion-chip>
              </ion-col>
              <ion-col size="12">
                <app-input-select-reactive
                  title="Scaffold Type"
                  placeholder="Select Type"
                  controlName="type"
                  [form]="attachment"
                  [selectedText]="arrField('attachments', i, 'type').value"
                >
                  <ng-container *ngIf="types$ | async as types">
                    <ion-select-option
                      [value]="type"
                      *ngFor="let type of types.types"
                      >{{ type }}
                    </ion-select-option>
                  </ng-container>
                </app-input-select-reactive>
              </ion-col>
              <ion-col size="6">
                <app-input-reactive
                  title="Description"
                  controlName="description"
                  placeholder="Enter description"
                  [form]="attachment"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col size="3">
                <app-input-reactive
                  title="Extra Hire %"
                  type="number"
                  controlName="extraHirePercentage"
                  placeholder="%"
                  [form]="attachment"
                  (fieldChange)="update('attachments', i)"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col size="3">
                <app-input-reactive
                  title="Extra Hire ({{ company.currency.symbol }})"
                  type="number"
                  controlName="extraHire"
                  placeholder="Total Extra Hire"
                  [form]="attachment"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Length ({{ company.measurement.symbol }})"
                  type="number"
                  controlName="length"
                  placeholder="L"
                  [form]="attachment"
                  (fieldChange)="update('attachments', i)"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Width ({{ company.measurement.symbol }})"
                  type="number"
                  controlName="width"
                  placeholder="W"
                  [form]="attachment"
                  (fieldChange)="update('attachments', i)"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Height ({{ company.measurement.symbol }})"
                  type="number"
                  controlName="height"
                  placeholder="H"
                  [form]="attachment"
                  (fieldChange)="update('attachments', i)"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Lifts"
                  type="number"
                  controlName="lifts"
                  placeholder="No. of Lifts"
                  [form]="attachment"
                  (fieldChange)="update('attachments', i)"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Boarded Lifts"
                  type="number"
                  controlName="boardedLifts"
                  [form]="attachment"
                  placeholder="No. Boarded Lifts"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Level"
                  [optional]="true"
                  type="number"
                  controlName="level"
                  placeholder="1"
                  [form]="attachment"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-select-reactive
                  title="Rate Profile"
                  placeholder="Select Rate"
                  controlName="rate"
                  [form]="attachment"
                  (fieldChange)="update('attachments', i)"
                  [selectedText]="arrField('attachments', i, 'rate').value.name"
                >
                  <ng-container *ngIf="rates$ | async as rates">
                    <ion-select-option
                      [value]="rate"
                      *ngFor="let rate of rates.scaffoldRates"
                      >{{ rate.name }}
                    </ion-select-option>
                  </ng-container>
                </app-input-select-reactive>
              </ion-col>
              <ion-col *ngIf="arrField('attachments', i, 'rate').value">
                <app-input-text
                  title="Rate override ({{
                    arrField('attachments', i, 'rate').value.name.startsWith(
                      '%'
                    )
                      ? '%'
                      : company.currency.symbol
                  }})"
                  type="number"
                  placeholder="Enter rate"
                  [value]="arrField('attachments', i, 'rate').value.rate"
                  (fieldChange)="updateRate('attachments', $event, i)"
                >
                </app-input-text>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Total ({{ company.currency.symbol }})"
                  type="number"
                  controlName="total"
                  [form]="attachment"
                  placeholder="Total"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col size="12" class="m-0 p-0">
                <ion-row class="m-0 p-0">
                  <ion-col size="12">
                    <ion-text class="small" color="medium"
                      >{{ company.terminology.hire }} Details</ion-text
                    >
                  </ion-col>
                  <ion-col>
                    <app-input-select-reactive
                      title="{{ company.terminology.hire }} Period"
                      placeholder="Select Hire Period"
                      controlName="isWeeks"
                      [form]="attachment"
                      [selectedText]="
                        arrField('attachments', i, 'isWeeks').value
                          ? 'Weeks'
                          : 'Days'
                      "
                      (fieldChange)="update('attachments', i)"
                    >
                      <ng-container>
                        <ion-select-option [value]="true"
                          >Weeks
                        </ion-select-option>
                        <ion-select-option [value]="false"
                          >Days
                        </ion-select-option>
                      </ng-container>
                    </app-input-select-reactive>
                  </ion-col>
                  <ion-col>
                    <app-input-reactive
                      [title]="
                        arrField('attachments', i, 'isWeeks').value
                          ? 'Weeks Standing'
                          : 'Days Standing'
                      "
                      type="number"
                      controlName="daysStanding"
                      [form]="attachment"
                      [placeholder]="
                        arrField('attachments', i, 'isWeeks').value
                          ? 'Enter Weeks'
                          : 'Enter Days'
                      "
                      (fieldChange)="update('attachments', i)"
                    >
                    </app-input-reactive>
                  </ion-col>
                  <ion-col>
                    <app-input-select-reactive
                      title="Rate Profile"
                      placeholder="Select Rate"
                      controlName="hireRate"
                      [form]="attachment"
                      [selectedText]="
                        arrField('attachments', i, 'hireRate').value.name
                      "
                      (fieldChange)="update('attachments', i)"
                    >
                      <ng-container *ngIf="rates$ | async as rates">
                        <ion-select-option
                          [value]="rate"
                          *ngFor="let rate of rates.hireRates"
                          >{{ rate.name }}
                        </ion-select-option>
                      </ng-container>
                    </app-input-select-reactive>
                  </ion-col>
                  <ion-col *ngIf="arrField('attachments', i, 'hireRate').value">
                    <app-input-text
                      title="Rate override ({{
                        arrField(
                          'attachments',
                          i,
                          'hireRate'
                        ).value.name.startsWith('%')
                          ? '%'
                          : company.currency.symbol
                      }})"
                      type="number"
                      [value]="
                        arrField('attachments', i, 'hireRate').value.rate
                      "
                      placeholder="Enter rate"
                      (fieldChange)="updateRate('attachmentHire', $event, i)"
                    >
                    </app-input-text>
                  </ion-col>
                  <ion-col>
                    <app-input-reactive
                      title="Total ({{ company.currency.symbol }})"
                      type="number"
                      controlName="hireTotal"
                      [form]="attachment"
                      [readonly]="true"
                      placeholder="Hire Total"
                    >
                    </app-input-reactive>
                  </ion-col>
                </ion-row>
              </ion-col>
            </ion-row>
            <ion-row class="mb-3">
              <ion-col>
                <ion-fab-button
                  size="small"
                  class="m-auto"
                  color="success"
                  (click)="addAttachment()"
                >
                  <ion-icon name="add"></ion-icon>
                </ion-fab-button>
              </ion-col>
            </ion-row>
          </ion-col>
        </ion-row>
        <!-- BOARDS -->
        <ion-row class="px-3">
          <ion-col size="12">
            <ion-text color="medium">
              <h4>{{ company.terminology.boards }} Details</h4>
            </ion-text>
          </ion-col>
        </ion-row>
        <ion-row
          formArrayName="boards"
          class="card-outline mb-3"
          *ngFor="let board of boardForms.controls; let i = index"
        >
          <ion-col size="12">
            <ion-note> Item {{ i + 1 }} </ion-note>
            <ion-chip
              outline
              color="danger"
              class="ion-float-end"
              (click)="deleteBoard(i)"
            >
              <ion-label>Delete</ion-label>
            </ion-chip>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Length ({{ company.measurement.symbol }})"
              type="number"
              controlName="length"
              placeholder="L"
              [form]="board"
              (fieldChange)="update('boards', i)"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Width ({{ company.measurement.symbol }})"
              type="number"
              controlName="width"
              placeholder="W"
              [form]="board"
              (fieldChange)="update('boards', i)"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Level ({{ company.measurement.symbol }})"
              type="number"
              controlName="height"
              placeholder="H"
              [form]="board"
              (fieldChange)="update('boards', i)"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Qty"
              type="number"
              controlName="qty"
              placeholder="Enter Qty"
              [form]="board"
              (fieldChange)="update('boards', i)"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col>
            <app-input-select-reactive
              title="Rate Profile"
              placeholder="Select Rate"
              controlName="rate"
              [form]="board"
              (fieldChange)="update('boards', i)"
              [selectedText]="arrField('boards', i, 'rate').value.name"
            >
              <ng-container *ngIf="rates$ | async as rates">
                <ion-select-option
                  [value]="rate"
                  *ngFor="let rate of rates.boardRates"
                  >{{ rate.name }}
                </ion-select-option>
              </ng-container>
            </app-input-select-reactive>
          </ion-col>
          <ion-col *ngIf="arrField('boards', i, 'rate').value">
            <app-input-text
              title="Rate override ({{
                arrField('boards', i, 'rate').value.name.startsWith('%')
                  ? '%'
                  : company.currency.symbol
              }})"
              type="number"
              placeholder="Enter rate"
              [value]="arrField('boards', i, 'rate').value.rate"
              (fieldChange)="updateRate('boards', $event, i)"
            >
            </app-input-text>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Extra Hire %"
              type="number"
              controlName="extraHirePercentage"
              placeholder="%"
              [form]="board"
              (fieldChange)="updateRate('boards', null, i)"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Extra Hire ({{ company.currency.symbol }})"
              type="number"
              controlName="extraHire"
              placeholder="Total Extra Hire"
              [form]="board"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Total ({{ company.currency.symbol }})"
              type="number"
              controlName="total"
              [form]="board"
              placeholder="Total"
              [readonly]="true"
            >
            </app-input-reactive>
          </ion-col>
        </ion-row>
        <ion-row class="mb-3">
          <ion-col>
            <ion-fab-button
              size="small"
              class="m-auto"
              color="success"
              (click)="addBoard()"
            >
              <ion-icon name="add"></ion-icon>
            </ion-fab-button>
          </ion-col>
        </ion-row>
        <!-- HIRE -->
        <ion-row
          class="card-outline mb-3"
          *ngIf="isEdit && +field('hire').value.total > 0"
        >
          <ion-col size="12">
            <ion-text color="medium">
              <h4>{{ company.terminology.hire }} Details</h4>
            </ion-text>
          </ion-col>
          <ion-col size="12">
            <ion-row formGroupName="hire">
              <ion-col>
                <app-input-select-reactive
                  title="Period"
                  placeholder="Select Hire Period"
                  controlName="isWeeks"
                  [form]="field('hire')"
                  [selectedText]="
                    field('hire.isWeeks').value ? 'Weeks' : 'Days'
                  "
                  (fieldChange)="update('hire')"
                >
                  <ng-container>
                    <ion-select-option [value]="true">Weeks </ion-select-option>
                    <ion-select-option [value]="false">Days </ion-select-option>
                  </ng-container>
                </app-input-select-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  [title]="
                    field('hire.isWeeks').value
                      ? 'Weeks Standing'
                      : 'Days Standing'
                  "
                  type="number"
                  controlName="daysStanding"
                  [form]="field('hire')"
                  [placeholder]="
                    field('hire.isWeeks').value ? 'Enter Weeks' : 'Enter Days'
                  "
                  (fieldChange)="update('hire')"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-select-reactive
                  title="Rate Profile"
                  placeholder="Select Rate"
                  controlName="rate"
                  [form]="field('hire')"
                  [selectedText]="field('hire.rate').value.name"
                  (fieldChange)="update('hire')"
                >
                  <ng-container *ngIf="rates$ | async as rates">
                    <ion-select-option
                      [value]="rate"
                      *ngFor="let rate of rates.hireRates"
                      >{{ rate.name }}
                    </ion-select-option>
                  </ng-container>
                </app-input-select-reactive>
              </ion-col>
              <ion-col *ngIf="field('hire.rate').value">
                <app-input-text
                  title="Rate override ({{
                    field('hire.rate').value.name.startsWith('%')
                      ? '%'
                      : company.currency.symbol
                  }})"
                  type="number"
                  [value]="field('hire.rate').value.rate"
                  placeholder="Enter rate"
                  (fieldChange)="updateRate('hire', $event)"
                >
                </app-input-text>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Total ({{ company.currency.symbol }})"
                  type="number"
                  controlName="total"
                  [form]="field('hire')"
                  [readonly]="true"
                  placeholder="Total"
                >
                </app-input-reactive>
              </ion-col>
            </ion-row>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col size="12" class="text-end">
            <ion-button shape="round" (click)="nextView('labour')"
              >Next</ion-button
            >
          </ion-col>
        </ion-row>
      </ion-grid>

      <!-- LABOUR TAB -->

      <ion-grid *ngSwitchCase="'labour'">
        <ion-row class="mt-3" class="card-outline mb-3">
          <ion-col size="12">
            <ion-text color="medium">
              <h4>Labor Information</h4>
            </ion-text>
          </ion-col>
          <ion-col>
            <app-input-select-reactive
              title="Labor Profile"
              placeholder="Select Labor Profile"
              controlName="broker"
              [form]="form"
              [selectedText]="field('broker').value.name"
              (fieldChange)="changeBroker()"
            >
              <ng-container *ngIf="brokers$ | async as brokers">
                <ion-select-option
                  [value]="broker"
                  *ngFor="let broker of brokers"
                  >{{ broker.name }}
                </ion-select-option>
              </ng-container>
            </app-input-select-reactive>
          </ion-col>
        </ion-row>

        <ng-container *ngIf="field('broker').value">
          <ion-row
            formArrayName="labour"
            class="card-outline mb-3"
            *ngFor="let labour of labourForms.controls; let i = index"
          >
            <ion-col size="12">
              <ion-note> Item {{ i + 1 }} </ion-note>
              <ion-chip
                outline
                color="danger"
                class="ion-float-end"
                (click)="deleteLabour(i)"
              >
                <ion-label>Delete</ion-label>
              </ion-chip>
            </ion-col>
            <ion-col>
              <app-input-select-reactive
                title="Type"
                placeholder="Select Labour Type"
                controlName="type"
                [form]="labour"
                [selectedText]="arrField('labour', i, 'type').value.name"
                (fieldChange)="update('labour', i)"
              >
                <ng-container>
                  <ion-select-option
                    [value]="broker"
                    *ngFor="let broker of field('broker').value.types"
                  >
                    {{ broker.name }}
                  </ion-select-option>
                </ng-container>
              </app-input-select-reactive>
            </ion-col>
            <ng-container *ngIf="arrField('labour', i, 'type').value">
              <ion-col>
                <app-input-reactive
                  title="Hours per day"
                  type="number"
                  controlName="hours"
                  [form]="labour"
                  placeholder="Enter hours"
                  (fieldChange)="update('labour', i)"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Days needed"
                  type="number"
                  controlName="days"
                  [form]="labour"
                  placeholder="Enter days"
                  (fieldChange)="update('labour', i)"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Qty"
                  type="number"
                  controlName="qty"
                  [form]="labour"
                  placeholder="Qty"
                  (fieldChange)="update('labour', i)"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-select-reactive
                  title="Rate Profile"
                  placeholder="Select Rate"
                  controlName="rate"
                  [form]="labour"
                  (fieldChange)="update('labour', i)"
                  [selectedText]="arrField('labour', i, 'rate').value.name"
                >
                  <ng-container>
                    <ion-select-option
                      [value]="{
                        name: 'NT',
                        rate: arrField('labour', i, 'type').value.nt
                      }"
                    >
                      Normal time
                    </ion-select-option>
                    <ion-select-option
                      [value]="{
                        name: 'OT1',
                        rate: arrField('labour', i, 'type').value.ot1
                      }"
                    >
                      Over time 1
                    </ion-select-option>
                    <ion-select-option
                      [value]="{
                        name: 'OT2',
                        rate: arrField('labour', i, 'type').value.ot2
                      }"
                    >
                      Over time 2
                    </ion-select-option>
                    <ion-select-option
                      [value]="{
                        name: 'PH',
                        rate: arrField('labour', i, 'type').value.ph
                      }"
                    >
                      Public holiday
                    </ion-select-option>
                  </ng-container>
                </app-input-select-reactive>
              </ion-col>
              <ion-col *ngIf="arrField('labour', i, 'rate').value">
                <app-input-text
                  title="Rate override ({{
                    arrField('labour', i, 'rate').value.name.startsWith('%')
                      ? '%'
                      : company.currency.symbol
                  }})"
                  type="number"
                  [value]="arrField('labour', i, 'rate').value.rate"
                  placeholder="Enter rate"
                  (fieldChange)="updateRate('labour', $event, i)"
                >
                </app-input-text>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Total ({{ company.currency.symbol }})"
                  type="number"
                  controlName="total"
                  [form]="labour"
                  placeholder="Total"
                  [readonly]="true"
                >
                </app-input-reactive>
              </ion-col>
            </ng-container>
          </ion-row>

          <ion-row>
            <ion-col>
              <ion-fab-button
                size="small"
                class="m-auto"
                color="success"
                (click)="addLabour()"
              >
                <ion-icon name="add"></ion-icon>
              </ion-fab-button>
            </ion-col>
          </ion-row>
        </ng-container>
        <ion-row>
          <ion-col size="12" class="text-end">
            <ion-button shape="round" (click)="nextView('transport')"
              >Next</ion-button
            >
          </ion-col>
        </ion-row>
      </ion-grid>

      <!-- TRANSPORT TAB -->

      <ion-grid *ngSwitchCase="'transport'">
        <ion-row class="mt-3" class="card-outline mb-3">
          <ion-col size="12">
            <ion-text color="medium">
              <h4>Transport Information</h4>
            </ion-text>
          </ion-col>
          <ion-col>
            <app-input-select-reactive
              title="Transport Profile"
              placeholder="Select Transport Profile"
              controlName="transportProfile"
              [form]="form"
              [selectedText]="field('transportProfile').value.name"
              (fieldChange)="changeTransport()"
            >
              <ng-container *ngIf="transport$ | async as profiles">
                <ion-select-option
                  [value]="profile"
                  *ngFor="let profile of profiles"
                  >{{ profile.name }}
                </ion-select-option>
              </ng-container>
            </app-input-select-reactive>
          </ion-col>
        </ion-row>

        <ng-container *ngIf="field('transportProfile').value">
          <ion-row
            formArrayName="transport"
            class="card-outline mb-3"
            *ngFor="let transport of transportForms.controls; let i = index"
          >
            <ion-col size="12">
              <ion-note> Item {{ i + 1 }} </ion-note>
              <ion-chip
                outline
                color="danger"
                class="ion-float-end"
                (click)="deleteTransport(i)"
              >
                <ion-label>Delete</ion-label>
              </ion-chip>
            </ion-col>
            <ion-col>
              <app-input-select-reactive
                title="Type"
                placeholder="Select Vehicle Type"
                controlName="type"
                [form]="transport"
                [selectedText]="arrField('transport', i, 'type').value.name"
                (fieldChange)="update('transport', i)"
              >
                <ng-container>
                  <ion-select-option
                    [value]="vehicle"
                    *ngFor="
                      let vehicle of field('transportProfile').value.types
                    "
                  >
                    {{ vehicle.name }}
                  </ion-select-option>
                </ng-container>
              </app-input-select-reactive>
            </ion-col>
            <ng-container *ngIf="arrField('transport', i, 'type').value">
              <ion-col>
                <app-input-text
                  title="Max Load ({{ company.mass.symbol }})"
                  type="number"
                  [value]="arrField('transport', i, 'type').value.maxLoad"
                  [readonly]="true"
                >
                </app-input-text>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Hours per day"
                  type="number"
                  controlName="hours"
                  [form]="transport"
                  placeholder="Enter hours"
                  (fieldChange)="update('transport', i)"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Days needed"
                  type="number"
                  controlName="days"
                  [form]="transport"
                  placeholder="Enter days"
                  (fieldChange)="update('transport', i)"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Qty"
                  type="number"
                  controlName="qty"
                  [form]="transport"
                  placeholder="Qty"
                  (fieldChange)="update('transport', i)"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-text
                  title="Rate override ({{ company.currency.symbol }})"
                  type="number"
                  [value]="arrField('transport', i, 'type').value.rate"
                  placeholder="Enter rate"
                  (fieldChange)="updateRate('transport', $event, i)"
                >
                </app-input-text>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Extra Hire %"
                  type="number"
                  controlName="extraHirePercentage"
                  placeholder="%"
                  [form]="transport"
                  (fieldChange)="updateRate('transport', null, i)"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Extra Hire ({{ company.currency.symbol }})"
                  type="number"
                  controlName="extraHire"
                  placeholder="Total Extra Hire"
                  [form]="transport"
                >
                </app-input-reactive>
              </ion-col>
              <ion-col>
                <app-input-reactive
                  title="Total ({{ company.currency.symbol }})"
                  type="number"
                  controlName="total"
                  [form]="transport"
                  placeholder="Total"
                  [readonly]="true"
                >
                </app-input-reactive>
              </ion-col>
            </ng-container>
          </ion-row>

          <ion-row>
            <ion-col>
              <ion-fab-button
                size="small"
                class="m-auto"
                color="success"
                (click)="addTransport()"
              >
                <ion-icon name="add"></ion-icon>
              </ion-fab-button>
            </ion-col>
          </ion-row>
        </ng-container>
        <ion-row>
          <ion-col size="12" class="text-end">
            <ion-button shape="round" (click)="nextView('additionals')"
              >Next</ion-button
            >
          </ion-col>
        </ion-row>
      </ion-grid>

      <!-- ADDITIONALS TAB -->

      <ion-grid *ngSwitchCase="'additionals'">
        <ion-row class="mt-3">
          <ion-col size="12">
            <ion-text color="medium">
              <h4>Additionals Information</h4>
            </ion-text>
          </ion-col>
        </ion-row>

        <ion-row
          formArrayName="additionals"
          class="card-outline mb-3"
          *ngFor="let additional of additionalForms.controls; let i = index"
        >
          <ion-col size="12">
            <ion-note> Item {{ i + 1 }} </ion-note>
            <ion-chip
              outline
              color="danger"
              class="ion-float-end"
              (click)="deleteAdditional(i)"
            >
              <ion-label>Delete</ion-label>
            </ion-chip>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Name"
              controlName="name"
              [form]="additional"
              placeholder="Item Name"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Qty"
              type="number"
              controlName="qty"
              [form]="additional"
              placeholder="Qty"
              (fieldChange)="update('additionals', i)"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Days on Hire"
              type="number"
              controlName="daysStanding"
              [form]="additional"
              placeholder="Days on hire"
              (fieldChange)="update('additionals', i)"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col>
            <app-input-select-reactive
              title="Rate Profile"
              placeholder="Select Rate"
              controlName="rate"
              [form]="additional"
              (fieldChange)="update('additionals', i)"
              [selectedText]="arrField('additionals', i, 'rate').value.name"
            >
              <ng-container *ngIf="rates$ | async as rates">
                <ion-select-option
                  [value]="rate"
                  *ngFor="let rate of rates.additionalRates"
                  >{{ rate.name }}
                </ion-select-option>
              </ng-container>
            </app-input-select-reactive>
          </ion-col>
          <ion-col *ngIf="arrField('additionals', i, 'rate').value">
            <app-input-text
              title="Rate override ({{
                arrField('additionals', i, 'rate').value.name.startsWith('%')
                  ? '%'
                  : company.currency.symbol
              }})"
              type="number"
              [value]="arrField('additionals', i, 'rate').value.rate"
              placeholder="Enter rate"
              (fieldChange)="updateRate('additionals', $event, i)"
            >
            </app-input-text>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Extra Hire %"
              type="number"
              controlName="extraHirePercentage"
              placeholder="%"
              [form]="additional"
              (fieldChange)="updateRate('additionals', null, i)"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Extra Hire ({{ company.currency.symbol }})"
              type="number"
              controlName="extraHire"
              placeholder="Total Extra Hire"
              [form]="additional"
            >
            </app-input-reactive>
          </ion-col>
          <ion-col>
            <app-input-reactive
              title="Total ({{ company.currency.symbol }})"
              type="number"
              controlName="total"
              [form]="additional"
              placeholder="Total"
              [readonly]="true"
            >
            </app-input-reactive>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col>
            <ion-fab-button
              size="small"
              class="m-auto"
              color="success"
              (click)="addAdditional()"
            >
              <ion-icon name="add"></ion-icon>
            </ion-fab-button>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="12" class="text-end">
            <ion-button shape="round" (click)="nextView('budget')"
              >Next</ion-button
            >
          </ion-col>
        </ion-row>
      </ion-grid>

      <!-- BUDGET TAB -->

      <ion-grid *ngSwitchCase="'budget'">
        <app-budget-breakdown [estimate]="estimate"></app-budget-breakdown>

        <ion-row>
          <ion-col size="12" class="text-end">
            <ion-button shape="round" (click)="nextView('summary')"
              >Next</ion-button
            >
          </ion-col>
        </ion-row>
      </ion-grid>

      <!-- SUMMARY TAB -->

      <ion-grid *ngSwitchCase="'summary'">
        <app-estimate-summary
          [value]="estimate"
          [canDownload]="isEdit && form.valid"
        ></app-estimate-summary>

        <ion-row>
          <ion-col size="12">
            <ion-item fill="solid" lines="none" class="rounded-3 mb-3">
              <ion-label>Exclude VAT on Estimate</ion-label>
              <ion-checkbox
                mode="ios"
                slot="end"
                [checked]="field('excludeVAT').value"
                (ionChange)="excludeVAT($event)"
                [disabled]="
                  estimate.status !== 'pending' && estimate.status !== 'revised'
                "
              ></ion-checkbox>
            </ion-item>
          </ion-col>
          <ion-progress-bar
            type="indeterminate"
            *ngIf="loading"
          ></ion-progress-bar>
          <ion-col
            *ngIf="
              isEdit &&
              (estimate.status === 'pending' || estimate.status === 'revised')
            "
          >
            <ion-button
              size="block"
              shape="round"
              color="danger"
              [disabled]="form.invalid"
              (click)="updateEstimate('rejected')"
              >Rejected</ion-button
            >
          </ion-col>
          <ion-col
            *ngIf="
              isEdit &&
              (estimate.status === 'pending' || estimate.status === 'revised')
            "
          >
            <ion-button
              size="block"
              shape="round"
              color="success"
              [disabled]="form.invalid"
              (click)="updateEstimate('accepted')"
            >
              Accepted
            </ion-button>
          </ion-col>
          <ion-col class="text-end">
            <ion-button
              size="block"
              shape="round"
              [disabled]="form.invalid"
              *ngIf="
                isEdit &&
                (estimate.status === 'pending' || estimate.status === 'revised')
              "
              (click)="updateEstimate(estimate.status)"
              >Update Estimate</ion-button
            >
            <ion-button
              size="block"
              shape="round"
              *ngIf="!isEdit"
              (click)="createEstimate()"
              >Save Estimate</ion-button
            >
          </ion-col>
          <ion-col
            class="text-end"
            *ngIf="isEdit && estimate.status === 'pending'"
          >
            <ion-button
              size="block"
              shape="round"
              color="tertiary"
              [disabled]="form.invalid"
              (click)="createRevision()"
              >Create Revision</ion-button
            >
          </ion-col>
          <ion-col
            size="12"
            *ngIf="user.role === 'Owner' || user.role === 'Super-Admin'"
          >
            <ion-button
              fill="outline"
              size="block"
              shape="round"
              color="danger"
              (click)="deleteEstimate()"
              >Delete Estimate</ion-button
            >
          </ion-col>
        </ion-row>
      </ion-grid>

      <ion-grid *ngSwitchCase="'comments'">
        <ion-row *ngIf="isEdit">
          <ion-col size="12">
            <ion-progress-bar
              type="indeterminate"
              *ngIf="addingComment"
            ></ion-progress-bar>
            <app-input-text
              title="Comment"
              [optional]="true"
              [value]="newComment"
              [textarea]="true"
              (fieldChange)="newComment = $event"
            ></app-input-text>
            <ion-button
              size="block"
              shape="round"
              color="success"
              (click)="addComment()"
              *ngIf="!addingComment"
              >Add Comment</ion-button
            >
          </ion-col>

          <ion-col size="12">
            <ion-list>
              <ion-list-header>
                <ion-text
                  ><h3>
                    {{ estimate.comments ? estimate.comments.length : 0 }}
                    Comments
                  </h3></ion-text
                >
              </ion-list-header>
              <ion-row *ngIf="estimate.comments">
                <ion-col
                  size="12"
                  *ngFor="let item of estimate.comments.reverse()"
                >
                  <div class="card p-3 gap">
                    <div class="d-flex mb-2">
                      <ion-avatar> <img [src]="item.image" /> </ion-avatar>
                      <div class="my-auto ps-2">
                        <ion-text class="h6">{{ item.name }} </ion-text><br />
                        <ion-text color="medium">
                          {{
                            (item.date.toDate ? item.date.toDate() : item.date)
                              | date : "dd MMM yyyy HH:mm"
                          }}
                        </ion-text>
                      </div>
                    </div>
                    <div>
                      <ion-text color="medium">
                        {{ item.message }}
                      </ion-text>
                    </div>
                  </div>
                </ion-col>
              </ion-row>
            </ion-list>
          </ion-col>
        </ion-row>
      </ion-grid>
    </form>
  </div>
</ion-content>
